<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad++ Sidebar - Espa√±ol</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Notepad++">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231e1e1e' width='100' height='100' rx='20'/><text y='70' x='50' text-anchor='middle' font-size='60'>üìù</text></svg>">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <!-- CodeMirror Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/nord.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-palenight.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/tomorrow-night-eighties.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/gruvbox-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/ayu-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/oceanic-next.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/idea.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/neat.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/ambiance.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/railscasts.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/rubyblue.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/xq-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/yeti.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/matchesonscrollbar.min.css">
    
    <!-- Devicons for language icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css">
    
    <!-- SQL Formatter -->
    <script src="https://unpkg.com/sql-formatter@15.0.2/dist/sql-formatter.min.js"></script>
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    
    <!-- Language modes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/r/r.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/go/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/simple.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/rust/rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/ruby/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/perl/perl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/powershell/powershell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/dockerfile/dockerfile.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/toml/toml.min.js"></script>
    
    <!-- Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/indent-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/comment-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/match-highlighter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/annotatescrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/matchesonscrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/autorefresh.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/mark-selection.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/jump-to-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/sublime.min.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d2d;
            --bg-hover: #383838;
            --bg-toolbar: #333;
            --border-color: #3c3c3c;
            --text-primary: #d4d4d4;
            --text-secondary: #888;
            --accent-color: #007acc;
            --accent-hover: #1177bb;
            --btn-bg: #0e639c;
            --warning-color: #f0ad4e;
            --success-color: #4ec9b0;
            --dropdown-bg: #252526;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f3f3;
            --bg-tertiary: #e8e8e8;
            --bg-hover: #d4d4d4;
            --bg-toolbar: #f0f0f0;
            --border-color: #d1d1d1;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-color: #0066b8;
            --accent-hover: #0055a0;
            --btn-bg: #0066b8;
            --warning-color: #e69500;
            --success-color: #16825d;
            --dropdown-bg: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* Toolbar Icons */
        .icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .icon svg {
            width: 16px;
            height: 16px;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            min-height: 36px;
        }

        .tabs-container::-webkit-scrollbar {
            height: 3px;
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 3px;
        }

        .tab {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-color);
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            min-width: 90px;
            max-width: 180px;
            transition: background 0.2s, transform 0.15s, opacity 0.15s;
            user-select: none;
        }

        .tab.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .tab.drag-over {
            border-left: 3px solid var(--accent-color);
            background: var(--bg-hover);
        }

        .tab.drag-over-right {
            border-right: 3px solid var(--accent-color);
            background: var(--bg-hover);
        }

        /* Tab Groups */
        .tab-group {
            display: flex;
            align-items: center;
            position: relative;
        }

        .tab-group-header {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
            min-width: 30px;
            transition: all 0.2s;
        }

        .tab-group-header:hover {
            filter: brightness(1.1);
        }

        .tab-group-header .group-label {
            margin-left: 4px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-group-header .group-collapse {
            margin-left: 4px;
            font-size: 10px;
            transition: transform 0.2s;
        }

        .tab-group.collapsed .group-collapse {
            transform: rotate(-90deg);
        }

        .tab-group.collapsed .tab {
            display: none;
        }

        .tab-group-tabs {
            display: flex;
        }

        /* Group colors */
        .tab-group[data-color="red"] .tab-group-header { background: #e74c3c; color: white; }
        .tab-group[data-color="red"] .tab { border-top: 2px solid #e74c3c; }
        
        .tab-group[data-color="orange"] .tab-group-header { background: #e67e22; color: white; }
        .tab-group[data-color="orange"] .tab { border-top: 2px solid #e67e22; }
        
        .tab-group[data-color="yellow"] .tab-group-header { background: #f1c40f; color: #333; }
        .tab-group[data-color="yellow"] .tab { border-top: 2px solid #f1c40f; }
        
        .tab-group[data-color="green"] .tab-group-header { background: #27ae60; color: white; }
        .tab-group[data-color="green"] .tab { border-top: 2px solid #27ae60; }
        
        .tab-group[data-color="blue"] .tab-group-header { background: #3498db; color: white; }
        .tab-group[data-color="blue"] .tab { border-top: 2px solid #3498db; }
        
        .tab-group[data-color="purple"] .tab-group-header { background: #9b59b6; color: white; }
        .tab-group[data-color="purple"] .tab { border-top: 2px solid #9b59b6; }
        
        .tab-group[data-color="pink"] .tab-group-header { background: #e91e63; color: white; }
        .tab-group[data-color="pink"] .tab { border-top: 2px solid #e91e63; }
        
        .tab-group[data-color="cyan"] .tab-group-header { background: #00bcd4; color: white; }
        .tab-group[data-color="cyan"] .tab { border-top: 2px solid #00bcd4; }

        /* Context menu for tabs */
        .tab-context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            min-width: 180px;
            padding: 4px 0;
            display: none;
        }

        .tab-context-menu.active {
            display: block;
        }

        .tab-context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
        }

        .tab-context-menu-item:hover {
            background: var(--bg-hover);
        }

        .tab-context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .tab-context-menu-colors {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.15s, border-color 0.15s;
        }

        .color-option:hover {
            transform: scale(1.2);
            border-color: var(--text-primary);
        }

        .color-option[data-color="red"] { background: #e74c3c; }
        .color-option[data-color="orange"] { background: #e67e22; }
        .color-option[data-color="yellow"] { background: #f1c40f; }
        .color-option[data-color="green"] { background: #27ae60; }
        .color-option[data-color="blue"] { background: #3498db; }
        .color-option[data-color="purple"] { background: #9b59b6; }
        .color-option[data-color="pink"] { background: #e91e63; }
        .color-option[data-color="cyan"] { background: #00bcd4; }

        .tab.active {
            background: var(--bg-primary);
            border-bottom: 2px solid var(--accent-color);
        }

        .tab:hover {
            background: var(--bg-hover);
        }

        .tab-icon {
            margin-right: 8px;
            display: flex;
            align-items: center;
            font-size: 16px;
        }

        .tab-icon i {
            font-size: 16px;
        }

        .tab-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            margin-left: 8px;
            width: 18px;
            height: 18px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: opacity 0.2s, background 0.2s;
            font-size: 14px;
        }

        .tab-close:hover {
            background: var(--bg-hover);
            opacity: 1;
        }

        .tab-modified .tab-name::after {
            content: " ‚óè";
            color: var(--warning-color);
        }

        .new-tab-btn {
            padding: 6px 14px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
            font-size: 18px;
        }

        .new-tab-btn:hover {
            color: #4ec9b0;
            background: var(--bg-hover);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 3px;
            padding: 5px 8px;
            background: var(--bg-toolbar);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar button {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s, transform 0.1s;
            font-size: 13px;
            font-weight: 500;
        }

        .toolbar button:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
        }

        .toolbar button:active {
            transform: translateY(0);
        }

        .toolbar button.active {
            background: var(--accent-color);
            color: #fff;
        }

        .toolbar select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            max-width: 110px;
            cursor: pointer;
        }

        .toolbar .separator {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 6px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* Colorful toolbar icons */
        .tb-new { color: #4ec9b0; }
        .tb-open { color: #dcdcaa; }
        .tb-save { color: #569cd6; }
        .tb-export { color: #c586c0; }
        .tb-undo { color: #ce9178; }
        .tb-redo { color: #ce9178; }
        .tb-json { color: #f1c40f; }
        .tb-sql { color: #e74c3c; }
        .tb-search { color: #9cdcfe; }
        .tb-goto { color: #b5cea8; }
        .tb-comment { color: #6a9955; }
        .tb-wrap { color: #d7ba7d; }
        .tb-theme-dark { color: #ffd700; }
        .tb-theme-light { color: #ff8c00; }

        /* Dropdown menu */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            min-width: 160px;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            padding: 4px 0;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content button {
            display: flex;
            width: 100%;
            text-align: left;
            padding: 8px 14px;
            border-radius: 0;
            font-size: 12px;
        }

        .dropdown-content button:hover {
            background: var(--accent-color);
            color: #fff;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Theme Selector */
        .theme-selector {
            position: relative;
            display: inline-block;
        }

        .theme-selector-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            max-width: 120px;
        }

        .theme-selector-btn:hover {
            background: var(--bg-hover);
        }

        .theme-dropdown {
            display: none;
            position: fixed;
            background: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10001;
            min-width: 180px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .theme-dropdown.show {
            display: block;
        }

        .theme-dropdown-header {
            padding: 8px 12px;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.15s;
        }

        .theme-option:hover {
            background: var(--bg-hover);
        }

        .theme-option.active {
            background: var(--accent-color);
            color: white;
        }

        .theme-preview {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
        }

        /* Global Search Modal */
        .global-search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            justify-content: center;
            align-items: flex-start;
            padding-top: 10%;
        }

        .global-search-modal.show {
            display: flex;
        }

        .global-search-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .global-search-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
        }

        .global-search-header input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        .global-search-header input:focus {
            border-color: var(--accent-color);
        }

        .global-search-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .global-search-close:hover {
            color: var(--text-primary);
        }

        .global-search-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .global-search-result {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s;
        }

        .global-search-result:hover {
            background: var(--bg-hover);
        }

        .global-search-result:last-child {
            border-bottom: none;
        }

        .global-search-result-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .global-search-result-tab {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 13px;
        }

        .global-search-result-line {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .global-search-result-content {
            font-family: monospace;
            font-size: 12px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .global-search-result-content mark {
            background: #ffd700;
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }

        .global-search-no-results {
            padding: 30px;
            text-align: center;
            color: var(--text-secondary);
        }

        .global-search-stats {
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }


        /* Asistente IA Panel - Estilo ChatGPT */
        .ai-btn {
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%) !important;
        }

        .ai-btn:hover {
            filter: brightness(1.1);
        }

        .ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .ai-modal.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ai-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 95%;
            max-width: 800px;
            height: 85vh;
            max-height: 700px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
            color: white;
            flex-shrink: 0;
        }

        .ai-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-header h3 .ai-icon {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .ai-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ai-header button {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-header button:hover {
            background: rgba(255,255,255,0.25);
        }

        .ai-close {
            background: none !important;
            border: none !important;
            font-size: 24px !important;
            padding: 4px 8px !important;
            opacity: 0.8;
        }

        .ai-close:hover {
            opacity: 1;
        }

        .ai-settings {
            display: none;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-settings.show {
            display: block;
        }

        .ai-settings label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }

        .ai-settings input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .ai-settings input:focus {
            outline: none;
            border-color: #10a37f;
        }

        .ai-quick-actions {
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .ai-quick-actions-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .ai-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .ai-action-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .ai-action-btn:hover {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
            transform: translateY(-1px);
        }

        .ai-action-btn .icon {
            font-size: 14px;
        }

        .ai-chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        .ai-chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .ai-chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .ai-chat-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .ai-message {
            display: flex;
            gap: 12px;
            max-width: 90%;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .ai-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .ai-message.assistant .ai-message-avatar {
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
            color: white;
        }

        .ai-message.user .ai-message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .ai-message-content {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .ai-message.user .ai-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-message.assistant .ai-message-content {
            border-bottom-left-radius: 4px;
        }

        .ai-message-content pre {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            position: relative;
        }

        .ai-message.user .ai-message-content pre {
            background: rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.1);
        }

        .ai-message-content code {
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .ai-message.user .ai-message-content code {
            background: rgba(0,0,0,0.2);
        }

        .ai-code-copy {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .ai-message-content pre:hover .ai-code-copy {
            opacity: 1;
        }

        .ai-code-copy:hover {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
        }

        .ai-typing {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .ai-typing-dots {
            display: flex;
            gap: 4px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
        }

        .ai-typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .ai-typing-dot:nth-child(1) { animation-delay: 0s; }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        .ai-welcome {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .ai-welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .ai-welcome h4 {
            color: var(--text-primary);
            margin: 0 0 8px 0;
            font-size: 18px;
        }

        .ai-welcome p {
            margin: 0;
            font-size: 14px;
        }

        .ai-input-area {
            padding: 16px 24px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .ai-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 8px 8px 8px 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .ai-input-wrapper:focus-within {
            border-color: #10a37f;
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        .ai-input-wrapper textarea {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            max-height: 120px;
            padding: 8px 0;
            font-family: inherit;
        }

        .ai-input-wrapper textarea:focus {
            outline: none;
        }

        .ai-input-wrapper textarea::placeholder {
            color: var(--text-secondary);
        }

        .ai-send-btn {
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .ai-send-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ai-response-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-left: 44px;
        }

        .ai-response-actions button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .ai-response-actions button:hover {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
        }

        .ai-empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .ai-empty-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 20px;
            color: white;
        }

        .ai-empty-state h4 {
            color: var(--text-primary);
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .ai-empty-state p {
            color: var(--text-secondary);
            margin: 0 0 24px 0;
            font-size: 14px;
            max-width: 300px;
        }

        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .ai-suggestion {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .ai-suggestion:hover {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: row;
        }

        .editor-container.drag-highlight {
            background: rgba(102, 126, 234, 0.1);
            box-shadow: inset 0 0 0 3px rgba(102, 126, 234, 0.5);
        }

        .editor-container.drag-highlight::after {
            content: 'üìÇ Soltar para abrir archivo';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .CodeMirror {
            height: 100%;
            font-family: 'Consolas', 'Monaco', 'Fira Code', monospace;
            font-size: 13px;
        }

        .light-mode .CodeMirror {
            background: #fff;
        }

        /* Highlight matches */
        .cm-matchhighlight {
            background: rgba(255, 255, 0, 0.3);
        }

        .light-mode .cm-matchhighlight {
            background: rgba(255, 255, 0, 0.5);
        }

        .cm-search-match {
            background: rgba(255, 150, 0, 0.5);
            outline: 1px solid orange;
        }

        /* Find/Replace Panel */
        .find-panel {
            display: none;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .find-panel.active {
            display: flex;
        }

        .find-panel input[type="text"] {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            width: 150px;
        }

        .find-panel input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .find-panel button {
            background: var(--btn-bg);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .find-panel button:hover {
            background: var(--accent-hover);
        }

        .find-panel .close-find {
            background: transparent;
            color: var(--text-secondary);
            padding: 6px;
        }

        .find-panel .close-find:hover {
            color: #ff6b6b;
            background: var(--bg-hover);
        }

        .find-options {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .find-option {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.2s;
            font-weight: 600;
        }

        .find-option:hover {
            border-color: var(--accent-color);
        }

        .find-option.active {
            background: var(--accent-color);
            color: #fff;
            border-color: var(--accent-color);
        }

        .find-count {
            font-size: 11px;
            color: var(--success-color);
            min-width: 90px;
            font-weight: 500;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 5px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-size: 11px;
        }

        .light-mode .status-bar {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .status-bar .left, .status-bar .right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-bar .clickable {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .status-bar .clickable:hover {
            background: rgba(255,255,255,0.2);
        }

        #statusCursors {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            animation: pulse-cursor 1.5s infinite;
        }

        @keyframes pulse-cursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 24px;
            min-width: 300px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .modal-content h3 {
            margin-bottom: 18px;
            font-size: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-content h3 .modal-icon {
            font-size: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-content input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s, transform 0.1s;
        }

        .modal-buttons button:hover {
            transform: translateY(-1px);
        }

        .modal-buttons .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .modal-buttons .btn-primary:hover {
            opacity: 0.9;
        }

        .modal-buttons .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-buttons .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 3000;
            display: none;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            align-items: center;
            gap: 10px;
        }

        .toast.error {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        .toast .toast-icon {
            font-size: 18px;
        }

        .toast.show {
            display: flex;
            animation: fadeInOut 2.5s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        /* Tooltips manejados por JavaScript */

        /* Format button flash */
        .format-btn.success {
            animation: flashSuccess 0.5s ease;
        }

        @keyframes flashSuccess {
            0%, 100% { background: transparent; }
            50% { background: #4ec9b0; }
        }

        /* Language-specific colors for devicons */
        .devicon-python-plain { color: #3776ab; }
        .devicon-javascript-plain { color: #f7df1e; }
        .devicon-typescript-plain { color: #3178c6; }
        .devicon-html5-plain { color: #e34f26; }
        .devicon-css3-plain { color: #1572b6; }
        .devicon-java-plain { color: #007396; }
        .devicon-csharp-plain { color: #239120; }
        .devicon-cplusplus-plain { color: #00599c; }
        .devicon-c-plain { color: #a8b9cc; }
        .devicon-php-plain { color: #777bb4; }
        .devicon-ruby-plain { color: #cc342d; }
        .devicon-go-plain { color: #00add8; }
        .devicon-rust-plain { color: #000000; }
        .light-mode .devicon-rust-plain { color: #dea584; }
        .devicon-perl-plain { color: #39457e; }
        .devicon-bash-plain { color: #4eaa25; }
        .devicon-powershell-plain { color: #5391fe; }
        .devicon-yaml-plain { color: #cb171e; }
        .devicon-markdown-original { color: #083fa1; }
        .devicon-docker-plain { color: #2496ed; }
        .devicon-r-plain { color: #276dc3; }
        .devicon-json-plain { color: #5c5c5c; }
        .light-mode .devicon-json-plain { color: #f7df1e; }
        
        .icon-sql { color: #e74c3c; }
        .icon-xml { color: #ff6600; }
        .icon-toml { color: #9c4121; }
        .icon-text { color: #888; }

        /* Markdown Preview Styles */
        .md-preview-container {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding: 20px 30px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }

        .md-preview-container.active {
            display: block;
        }

        .md-preview-container h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; margin: 0.67em 0; }
        .md-preview-container h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; margin: 0.83em 0; }
        .md-preview-container h3 { font-size: 1.25em; margin: 1em 0; }
        .md-preview-container h4 { font-size: 1em; margin: 1.33em 0; }
        .md-preview-container p { margin: 1em 0; }
        .md-preview-container a { color: var(--accent-color); text-decoration: none; }
        .md-preview-container a:hover { text-decoration: underline; }
        .md-preview-container code { 
            background: var(--bg-tertiary); 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }
        .md-preview-container pre { 
            background: var(--bg-tertiary); 
            padding: 16px; 
            border-radius: 6px; 
            overflow-x: auto;
            margin: 1em 0;
        }
        .md-preview-container pre code { 
            background: none; 
            padding: 0; 
        }
        .md-preview-container blockquote { 
            border-left: 4px solid var(--accent-color); 
            margin: 1em 0;
            padding: 0.5em 1em; 
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }
        .md-preview-container ul, .md-preview-container ol { margin: 1em 0; padding-left: 2em; }
        .md-preview-container li { margin: 0.5em 0; }
        .md-preview-container table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .md-preview-container th, .md-preview-container td { 
            border: 1px solid var(--border-color); 
            padding: 8px 12px; 
            text-align: left; 
        }
        .md-preview-container th { background: var(--bg-tertiary); font-weight: 600; }
        .md-preview-container hr { border: none; border-top: 1px solid var(--border-color); margin: 2em 0; }
        .md-preview-container img { max-width: 100%; height: auto; }
        .md-preview-container strong { font-weight: 600; }
        .md-preview-container em { font-style: italic; }

        /* Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-modal-content {
            background: var(--bg-primary);
            width: 90%;
            max-width: 900px;
            height: 85%;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .preview-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 12px 12px 0 0;
        }

        .preview-modal-header h3 {
            margin: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .preview-modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .preview-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
        }

        /* Preview toggle button */
        .preview-toggle.active {
            background: var(--accent-color) !important;
            color: white !important;
        }

        /* Split View Mode */
        .editor-container.split-view {
            display: flex;
            flex-direction: row;
        }

        .editor-container.split-view .CodeMirror {
            width: 100% !important;
            height: 100% !important;
            border-right: none;
        }

        .editor-container.split-view .split-editor-wrapper {
            display: flex;
            flex: none;
            width: 50%;
            min-width: 20%;
            max-width: 80%;
            height: 100%;
            flex-shrink: 0;
        }

        .editor-container.split-view .md-preview-container {
            display: block;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        /* Split view resizer */
        .split-resizer {
            display: none;
            width: 6px;
            background: var(--border-color);
            cursor: col-resize;
            transition: background 0.2s;
            position: relative;
            flex-shrink: 0;
        }

        .split-resizer:hover,
        .split-resizer.dragging {
            background: var(--accent-color);
        }

        .split-resizer::after {
            content: '‚ãÆ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-size: 14px;
            pointer-events: none;
        }

        .split-resizer:hover::after,
        .split-resizer.dragging::after {
            color: white;
        }

        .editor-container.split-view .split-resizer {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Prevent text selection during resize */
        .editor-container.resizing,
        .editor-container.resizing * {
            user-select: none !important;
            -webkit-user-select: none !important;
            cursor: col-resize !important;
        }

        /* Preview modes indicator */
        .preview-mode-btn.active {
            background: var(--accent-color) !important;
            color: white !important;
        }

        /* Split view header */
        .split-preview-header {
            display: none;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .editor-container.split-view .split-preview-header {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .split-preview-wrapper {
            display: none;
            flex-direction: column;
            flex: 1;
            height: 100%;
            min-width: 20%;
        }

        .split-editor-wrapper {
            display: flex;
            flex: 1;
            width: 100%;
            height: 100%;
            min-width: 0;
            position: relative;
        }

        .split-editor-wrapper .CodeMirror {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100% !important;
            width: 100% !important;
        }

        /* Search highlight line */
        .search-highlight-line {
            background: rgba(255, 215, 0, 0.3) !important;
            animation: highlight-fade 2s ease-out;
        }

        @keyframes highlight-fade {
            0% { background: rgba(255, 215, 0, 0.5); }
            100% { background: transparent; }
        }

        .editor-container.split-view .split-preview-wrapper {
            display: flex;
        }

        /* Toggle mode - full width preview */
        .editor-container.toggle-preview .split-editor-wrapper {
            display: none;
        }

        .editor-container.toggle-preview .split-preview-wrapper {
            display: flex;
            width: 100%;
        }

        .editor-container.toggle-preview .split-preview-header {
            display: none;
        }

        .editor-container.toggle-preview .split-resizer {
            display: none;
        }

        .split-preview-wrapper .md-preview-container {
            flex: 1;
            width: 100% !important;
        }

        /* ========== Text Highlighter Styles ========== */
        .highlight-yellow { background-color: rgba(255, 235, 59, 0.4) !important; }
        .highlight-green { background-color: rgba(76, 175, 80, 0.4) !important; }
        .highlight-blue { background-color: rgba(33, 150, 243, 0.4) !important; }
        .highlight-pink { background-color: rgba(233, 30, 99, 0.4) !important; }
        .highlight-orange { background-color: rgba(255, 152, 0, 0.4) !important; }

        /* ========== Floating Highlighter Popup ========== */
        .highlighter-popup {
            position: fixed;
            display: none;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            animation: popupFadeIn 0.15s ease-out;
        }

        .highlighter-popup.show {
            display: flex;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .highlighter-popup .ht-btn {
            width: 22px;
            height: 22px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .highlighter-popup .ht-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .highlighter-popup .ht-btn[data-color="yellow"] { background: #ffeb3b; }
        .highlighter-popup .ht-btn[data-color="green"] { background: #4caf50; }
        .highlighter-popup .ht-btn[data-color="blue"] { background: #2196f3; }
        .highlighter-popup .ht-btn[data-color="pink"] { background: #e91e63; }
        .highlighter-popup .ht-btn[data-color="orange"] { background: #ff9800; }

        .highlighter-popup .ht-clear-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .highlighter-popup .ht-clear-btn:hover {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .highlighter-popup .ht-divider {
            width: 1px;
            height: 16px;
            background: var(--border);
            margin: 0 4px;
        }

        /* Light mode adjustments */
        .light-mode .highlighter-popup {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* ========== AI Model Selector ========== */
        .ai-model-selector {
            margin-top: 12px;
        }

        .ai-model-selector label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .ai-model-select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
        }

        .ai-model-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ========== AI Code Block with Export ========== */
        .ai-code-block {
            position: relative;
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            background: #1e1e1e;
        }

        .ai-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
        }

        .ai-code-lang {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            font-weight: 600;
        }

        .ai-code-actions {
            display: flex;
            gap: 6px;
        }

        .ai-code-btn {
            padding: 4px 10px;
            font-size: 11px;
            background: #404040;
            border: none;
            border-radius: 4px;
            color: #ccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .ai-code-btn:hover {
            background: #505050;
            color: #fff;
        }

        .ai-code-btn.primary {
            background: var(--accent);
            color: #fff;
        }

        .ai-code-btn.primary:hover {
            background: #0fa37f;
        }

        .ai-code-block pre {
            margin: 0;
            padding: 14px;
            overflow-x: auto;
        }

        .ai-code-block code {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .inline-code {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
        }

        .light-mode .inline-code {
            background: rgba(0,0,0,0.08);
        }

        /* ========== File Save Status ========== */
        .file-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-left: auto;
        }

        .file-status.saved { color: #4caf50; }
        .file-status.modified { color: #ff9800; }

        .file-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Light mode adjustments */
        .light-mode .ai-code-block {
            background: #f5f5f5;
        }

        .light-mode .ai-code-header {
            background: #e8e8e8;
            border-bottom-color: #ddd;
        }

        .light-mode .ai-code-lang {
            color: #666;
        }

        .light-mode .ai-code-btn {
            background: #ddd;
            color: #444;
        }

        .light-mode .ai-code-btn:hover {
            background: #ccc;
            color: #222;
        }

    </style>
    
    <!-- Markdown Parser (lightweight ~40KB) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for AI response code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <div class="tabs-container" id="tabsContainer">
        <button class="new-tab-btn" onclick="createNewTab()" data-tooltip="Nueva pesta√±a (Ctrl+N)">‚ûï</button>
    </div>

    <div class="toolbar">
        <div class="toolbar-group">
            <button onclick="createNewTab()" data-tooltip="Nuevo" class="tb-new">
                <span class="icon">üìÑ</span>
            </button>
            <button onclick="openFile()" data-tooltip="Abrir" class="tb-open">
                <span class="icon">üìÇ</span>
            </button>
            <div class="dropdown">
                <button data-tooltip="Guardar (Ctrl+S)" class="tb-save">
                    <span class="icon">üíæ</span>
                    <span style="font-size:10px;">‚ñº</span>
                </button>
                <div class="dropdown-content">
                    <button onclick="saveFile()">üíæ Guardar original</button>
                    <div class="dropdown-divider"></div>
                    <button onclick="exportAs('txt')">üìù Text (.txt)</button>
                    <button onclick="exportAs('pdf')">üìï PDF (.pdf)</button>
                    <button onclick="exportAs('html')">üåê HTML (.html)</button>
                    <button onclick="exportAs('doc')">üìÑ Word (.doc)</button>
                    <div class="dropdown-divider"></div>
                    <button onclick="exportAs('csv')">üìä CSV (.csv)</button>
                    <button onclick="exportAs('tsv')">üìã TSV (.tsv)</button>
                    <button onclick="exportAs('json')">üì¶ JSON (.json)</button>
                    <div class="dropdown-divider"></div>
                    <button onclick="printCode()">üñ®Ô∏è Imprimir (Ctrl+P)</button>
                </div>
            </div>
        </div>
        
        <div class="separator"></div>
        
        <div class="toolbar-group">
            <button onclick="editorUndo()" data-tooltip="Deshacer (Ctrl+Z)" class="tb-undo">
                <span class="icon">‚Ü©Ô∏è</span>
            </button>
            <button onclick="editorRedo()" data-tooltip="Rehacer (Ctrl+Y)" class="tb-redo">
                <span class="icon">‚Ü™Ô∏è</span>
            </button>
        </div>
        
        <div class="separator"></div>
        
        <div class="toolbar-group">
            <button onclick="formatJSON()" class="format-btn tb-json" id="formatJsonBtn" data-tooltip="Formatear JSON">
                <span class="icon">{ }</span>
            </button>
            <button onclick="formatSQL()" class="format-btn tb-sql" id="formatSqlBtn" data-tooltip="Formatear SQL">
                <span class="icon">üóÉÔ∏è</span>
            </button>
        </div>
        
        <div class="separator"></div>
        
        <div class="toolbar-group">
            <button onclick="toggleFind()" data-tooltip="Buscar (Ctrl+F)" class="tb-search">
                <span class="icon">üîç</span>
            </button>
            <button onclick="goToLine()" data-tooltip="Ir a l√≠nea (Ctrl+G)" class="tb-goto">
                <span class="icon">üî¢</span>
            </button>
            <button onclick="toggleComment()" data-tooltip="Comment (Ctrl+/)" class="tb-comment">
                <span class="icon">üí¨</span>
            </button>
            <button onclick="toggleWordWrap()" id="wrapBtn" data-tooltip="Ajuste de l√≠nea" class="tb-wrap">
                <span class="icon">‚Ü©Ô∏è</span>
            </button>
        </div>
        
        <div class="separator"></div>
        
        <select id="languageSelect" onchange="changeLanguage(this.value)" data-tooltip="Lenguaje">
            <option value="text">üìÑ Plain text</option>
            <option value="javascript">üü® JavaScript</option>
            <option value="python">üêç Python</option>
            <option value="sql">üóÉÔ∏è SQL</option>
            <option value="htmlmixed">üåê HTML</option>
            <option value="css">üé® CSS</option>
            <option value="xml">üìã XML</option>
            <option value="text/x-java">‚òï Java</option>
            <option value="text/x-csharp">üíú C#</option>
            <option value="text/x-csrc">üîµ C</option>
            <option value="text/x-c++src">üî∑ C++</option>
            <option value="php">üêò PHP</option>
            <option value="ruby">üíé Ruby</option>
            <option value="go">üîπ Go</option>
            <option value="rust">ü¶Ä Rust</option>
            <option value="perl">üê™ Perl</option>
            <option value="shell">üñ•Ô∏è Shell/Bash</option>
            <option value="powershell">üí† PowerShell</option>
            <option value="yaml">üìù YAML</option>
            <option value="markdown">üìë Markdown</option>
            <option value="dockerfile">üê≥ Dockerfile</option>
            <option value="toml">‚öôÔ∏è TOML</option>
            <option value="r">üìä R</option>
            <option value="application/json">üì¶ JSON</option>
        </select>
        
        <select id="fontSizeSelect" onchange="changeFontSize(this.value)" data-tooltip="Tama√±o de fuente">
            <option value="11">11px</option>
            <option value="12">12px</option>
            <option value="13" selected>13px</option>
            <option value="14">14px</option>
            <option value="15">15px</option>
            <option value="16">16px</option>
            <option value="18">18px</option>
            <option value="20">20px</option>
        </select>

        <div class="separator"></div>
        
        <div class="toolbar-group">
            <button onclick="zoomOut()" data-tooltip="Alejar (Ctrl+-)">
                <span class="icon">‚ûñ</span>
            </button>
            <span id="zoomLevel" style="font-size:11px; min-width:40px; text-align:center;">100%</span>
            <button onclick="zoomIn()" data-tooltip="Acercar (Ctrl++)">
                <span class="icon">‚ûï</span>
            </button>
            <button onclick="zoomReset()" data-tooltip="Restablecer zoom">
                <span class="icon">‚Ü∫</span>
            </button>
        </div>

        <div class="separator"></div>
        
        <!-- Quick Dark/Light Toggle -->
        <button onclick="quickToggleTheme()" data-tooltip="Cambiar Oscuro/Claro" id="quickThemeBtn">
            <span class="icon" id="quickThemeIcon">üåô</span>
        </button>
        
        <!-- Theme Selector -->
        <div class="theme-selector">
            <button class="theme-selector-btn" onclick="toggleThemeDropdown()" data-tooltip="Seleccionar tema">
                <span>üé®</span>
                <span id="currentThemeName">Dracula</span>
                <span>‚ñæ</span>
            </button>
            <div class="theme-dropdown" id="themeDropdown">
                <div class="theme-dropdown-header">üåô Temas Oscuros</div>
                <div class="theme-option active" data-theme="dracula" onclick="setTheme('dracula', 'Dracula', '#282a36')">
                    <span class="theme-preview" style="background: #282a36"></span>
                    <span>Dracula</span>
                </div>
                <div class="theme-option" data-theme="monokai" onclick="setTheme('monokai', 'Monokai', '#272822')">
                    <span class="theme-preview" style="background: #272822"></span>
                    <span>Monokai</span>
                </div>
                <div class="theme-option" data-theme="nord" onclick="setTheme('nord', 'Nord', '#2e3440')">
                    <span class="theme-preview" style="background: #2e3440"></span>
                    <span>Nord</span>
                </div>
                <div class="theme-option" data-theme="material-darker" onclick="setTheme('material-darker', 'Material Darker', '#212121')">
                    <span class="theme-preview" style="background: #212121"></span>
                    <span>Material Darker</span>
                </div>
                <div class="theme-option" data-theme="material-palenight" onclick="setTheme('material-palenight', 'Palenight', '#292d3e')">
                    <span class="theme-preview" style="background: #292d3e"></span>
                    <span>Palenight</span>
                </div>
                <div class="theme-option" data-theme="ayu-dark" onclick="setTheme('ayu-dark', 'Ayu Dark', '#0a0e14')">
                    <span class="theme-preview" style="background: #0a0e14"></span>
                    <span>Ayu Dark</span>
                </div>
                <div class="theme-option" data-theme="gruvbox-dark" onclick="setTheme('gruvbox-dark', 'Gruvbox Dark', '#282828')">
                    <span class="theme-preview" style="background: #282828"></span>
                    <span>Gruvbox Dark</span>
                </div>
                <div class="theme-option" data-theme="oceanic-next" onclick="setTheme('oceanic-next', 'Oceanic Next', '#1b2b34')">
                    <span class="theme-preview" style="background: #1b2b34"></span>
                    <span>Oceanic Next</span>
                </div>
                <div class="theme-option" data-theme="tomorrow-night-eighties" onclick="setTheme('tomorrow-night-eighties', 'Tomorrow Night', '#2d2d2d')">
                    <span class="theme-preview" style="background: #2d2d2d"></span>
                    <span>Tomorrow Night</span>
                </div>
                <div class="theme-option" data-theme="solarized dark" onclick="setTheme('solarized dark', 'Solarized Dark', '#002b36')">
                    <span class="theme-preview" style="background: #002b36"></span>
                    <span>Solarized Dark</span>
                </div>
                <div class="theme-option" data-theme="ambiance" onclick="setTheme('ambiance', 'Ambiance', '#202020')">
                    <span class="theme-preview" style="background: #202020"></span>
                    <span>Ambiance</span>
                </div>
                <div class="theme-option" data-theme="railscasts" onclick="setTheme('railscasts', 'Railscasts', '#2b2b2b')">
                    <span class="theme-preview" style="background: #2b2b2b"></span>
                    <span>Railscasts</span>
                </div>
                <div class="theme-option" data-theme="rubyblue" onclick="setTheme('rubyblue', 'Rubyblue', '#112435')">
                    <span class="theme-preview" style="background: #112435"></span>
                    <span>Rubyblue</span>
                </div>
                <div class="theme-dropdown-header">‚òÄÔ∏è Temas Claros</div>
                <div class="theme-option" data-theme="eclipse" onclick="setTheme('eclipse', 'Eclipse', '#ffffff')">
                    <span class="theme-preview" style="background: #ffffff"></span>
                    <span>Eclipse</span>
                </div>
                <div class="theme-option" data-theme="idea" onclick="setTheme('idea', 'IntelliJ', '#ffffff')">
                    <span class="theme-preview" style="background: #ffffff"></span>
                    <span>IntelliJ IDEA</span>
                </div>
                <div class="theme-option" data-theme="neat" onclick="setTheme('neat', 'Neat', '#ffffff')">
                    <span class="theme-preview" style="background: #ffffff"></span>
                    <span>Neat</span>
                </div>
                <div class="theme-option" data-theme="solarized light" onclick="setTheme('solarized light', 'Solarized Light', '#fdf6e3')">
                    <span class="theme-preview" style="background: #fdf6e3"></span>
                    <span>Solarized Light</span>
                </div>
                <div class="theme-option" data-theme="xq-light" onclick="setTheme('xq-light', 'XQ Light', '#ffffff')">
                    <span class="theme-preview" style="background: #ffffff"></span>
                    <span>XQ Light</span>
                </div>
                <div class="theme-option" data-theme="yeti" onclick="setTheme('yeti', 'Yeti', '#eceae8')">
                    <span class="theme-preview" style="background: #eceae8"></span>
                    <span>Yeti</span>
                </div>
            </div>
        </div>
        
        <!-- Global Search Button -->
        <button onclick="openGlobalSearch()" data-tooltip="Buscar en todas las pesta√±as (Ctrl+Shift+F)">
            <span class="icon">üîé</span>
        </button>

        <!-- Asistente IA Button -->
        <button onclick="openAIPanel()" data-tooltip="Asistente IA (Ctrl+Shift+A)" id="aiAssistBtn" class="ai-btn">
            <span class="icon">ü§ñ</span>
        </button>

        <div class="separator"></div>
        
        <div class="toolbar-group">
            <button onclick="toggleSplitView()" data-tooltip="Vista dividida (Editor + Vista previa)" id="splitViewBtn" class="preview-mode-btn">
                <span class="icon">üìñ</span>
            </button>
            <button onclick="toggleMdPreview()" data-tooltip="Alternar vista previa" id="mdPreviewToggle" class="preview-mode-btn">
                <span class="icon">üëÅÔ∏è</span>
            </button>
            <button onclick="openPreviewModal()" data-tooltip="Vista previa en ventana" class="preview-mode-btn">
                <span class="icon">üî≤</span>
            </button>
        </div>
    </div>

    <div class="find-panel" id="findPanel">
        <input type="text" id="findInput" placeholder="üîç Buscar..." onkeyup="handleFindKey(event)" oninput="highlightMatches()">
        <input type="text" id="replaceInput" placeholder="‚úèÔ∏è Reemplazar...">
        <button onclick="findPrev()" data-tooltip="Anterior (Shift+Enter)">‚¨ÜÔ∏è</button>
        <button onclick="findNext()" data-tooltip="Siguiente (Enter)">‚¨áÔ∏è</button>
        <button onclick="replaceOne()">Reemplazar</button>
        <button onclick="replaceAll()">Todo</button>
        <div class="find-options">
            <span class="find-option" id="regexOption" onclick="toggleFindOption('regex')" data-tooltip="Expresi√≥n regular">.*</span>
            <span class="find-option" id="caseOption" onclick="toggleFindOption('case')" data-tooltip="Coincidir may√∫sculas">Aa</span>
            <span class="find-option" id="wordOption" onclick="toggleFindOption('word')" data-tooltip="Palabra completa">W</span>
        </div>
        <span class="find-count" id="findCount"></span>
        <button class="close-find" onclick="toggleFind()">‚úñÔ∏è</button>
    </div>

    <div class="editor-container" id="editorContainer">
        <div class="split-editor-wrapper" id="splitEditorWrapper">
            <textarea id="editor"></textarea>
        </div>
        <div class="split-resizer" id="splitResizer"></div>
        <div class="split-preview-wrapper">
            <div class="split-preview-header">
                <span>üìñ</span> Preview
            </div>
            <div class="md-preview-container" id="mdPreview"></div>
        </div>
    </div>

    <div class="status-bar">
        <div class="left">
            <span id="statusFile">Sin t√≠tulo</span>
            <span id="statusLang" class="clickable" onclick="document.getElementById('languageSelect').focus()">
                <span id="statusLangIcon">üìÑ</span>
                <span id="statusLangName">Plain text</span>
            </span>
            <span id="statusCursors" class="clickable" data-tooltip="Ctrl+D: Seleccionar siguiente | Alt+Click: A√±adir cursor | Ctrl+Shift+L: Dividir selecci√≥n" style="display: none;">
                <span>‚åñ</span>
                <span id="cursorCount">1</span>
            </span>
        </div>
        <div class="right">
            <span id="statusPos">Ln 1, Col 1</span>
            <span id="statusSel"></span>
            <span id="statusLength">0 chars</span>
            <span id="statusWrap"></span>
            <span>UTF-8</span>
        </div>
    </div>

    <!-- Go to line modal -->
    <div class="modal" id="gotoModal">
        <div class="modal-content">
            <h3><span class="modal-icon">üî¢</span> Ir a l√≠nea</h3>
            <input type="number" id="gotoLineInput" placeholder="N√∫mero de l√≠nea..." min="1">
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('gotoModal')">‚ùå Cancelar</button>
                <button class="btn-primary" onclick="doGoToLine()">‚û°Ô∏è Ir</button>
            </div>
        </div>
    </div>

    <!-- Rename modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <h3><span class="modal-icon">‚úèÔ∏è</span> Renombrar archivo</h3>
            <input type="text" id="renameInput" placeholder="Nombre de archivo...">
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('renameModal')">‚ùå Cancelar</button>
                <button class="btn-primary" onclick="doRename()">‚úÖ Renombrar</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">‚úÖ</span>
        <span id="toastMessage"></span>
    </div>

    <input type="file" id="fileInput" style="display:none" onchange="handleFileOpen(event)">

    <!-- Tab context menu -->
    <div class="tab-context-menu" id="tabContextMenu">
        <div class="tab-context-menu-item" onclick="contextMenuAction('rename')">
            <span>‚úèÔ∏è</span> Renombrar
        </div>
        <div class="tab-context-menu-item" onclick="contextMenuAction('duplicate')">
            <span>üìã</span> Duplicate tab
        </div>
        <div class="tab-context-menu-divider"></div>
        <div class="tab-context-menu-item" onclick="contextMenuAction('newGroup')">
            <span>üìÅ</span> Add to new group
        </div>
        <div class="tab-context-menu-item" id="removeFromGroupItem" onclick="contextMenuAction('removeFromGroup')" style="display:none">
            <span>üì§</span> Remove from group
        </div>
        <div class="tab-context-menu-colors" id="groupColorsContainer">
            <div class="color-option" data-color="red" onclick="contextMenuAction('setColor', 'red')"></div>
            <div class="color-option" data-color="orange" onclick="contextMenuAction('setColor', 'orange')"></div>
            <div class="color-option" data-color="yellow" onclick="contextMenuAction('setColor', 'yellow')"></div>
            <div class="color-option" data-color="green" onclick="contextMenuAction('setColor', 'green')"></div>
            <div class="color-option" data-color="blue" onclick="contextMenuAction('setColor', 'blue')"></div>
            <div class="color-option" data-color="purple" onclick="contextMenuAction('setColor', 'purple')"></div>
            <div class="color-option" data-color="pink" onclick="contextMenuAction('setColor', 'pink')"></div>
            <div class="color-option" data-color="cyan" onclick="contextMenuAction('setColor', 'cyan')"></div>
        </div>
        <div class="tab-context-menu-divider"></div>
        <div class="tab-context-menu-item" onclick="contextMenuAction('close')">
            <span>‚úï</span> Cerrar pesta√±a
        </div>
        <div class="tab-context-menu-item" onclick="contextMenuAction('closeOthers')">
            <span>üóëÔ∏è</span> Cerrar otras pesta√±as
        </div>
    </div>

    <!-- Global Search Modal -->
    <div class="global-search-modal" id="globalSearchModal">
        <div class="global-search-container">
            <div class="global-search-header">
                <span>üîé</span>
                <input type="text" id="globalSearchInput" placeholder="Buscar en todas las pesta√±as..." autocomplete="off">
                <button class="global-search-close" onclick="closeGlobalSearch()">√ó</button>
            </div>
            <div class="global-search-results" id="globalSearchResults">
                <div class="global-search-no-results">
                    Escribe para buscar en todas tus pesta√±as...
                </div>
            </div>
            <div class="global-search-stats" id="globalSearchStats"></div>
        </div>
    </div>

    <!-- Floating Highlighter Toolbar -->
    <div class="highlighter-popup" id="highlighterPopup">
        <button class="ht-btn" data-color="yellow" title="Amarillo (Alt+1)"></button>
        <button class="ht-btn" data-color="green" title="Verde (Alt+2)"></button>
        <button class="ht-btn" data-color="blue" title="Azul (Alt+3)"></button>
        <button class="ht-btn" data-color="pink" title="Rosa (Alt+4)"></button>
        <button class="ht-btn" data-color="orange" title="Naranja (Alt+5)"></button>
        <div class="ht-divider"></div>
        <button class="ht-btn ht-clear-btn" data-action="clear" title="Quitar (Alt+0)">‚úï</button>
    </div>

    <!-- Asistente IA Modal -->
    <!-- AI Assist Modal - ChatGPT Style -->
    <div class="ai-modal" id="aiModal">
        <div class="ai-container">
            <div class="ai-header">
                <h3>
                    <span class="ai-icon">‚ú®</span>
                    Asistente IA
                    <span style="font-size: 11px; opacity: 0.7; font-weight: 400;">(Gemini)</span>
                </h3>
                <div class="ai-header-actions">
                    <button onclick="clearAIChat()">üóëÔ∏è Limpiar</button>
                    <button onclick="toggleAISettings()">‚öôÔ∏è Configuraci√≥n</button>
                    <button class="ai-close" onclick="closeAIPanel()">√ó</button>
                </div>
            </div>

            <div class="ai-settings" id="aiSettings">
                <label>üîë Clave API de Gemini</label>
                <input type="password" id="geminiApiKey" placeholder="Ingresa tu clave API de Gemini..." onchange="saveGeminiKey()">
                <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                    Obt√©n tu clave API gratis en <a href="https://aistudio.google.com/apikey" target="_blank" style="color: #10a37f;">aistudio.google.com</a>
                </p>
                <div class="ai-model-selector">
                    <label>ü§ñ Modelo</label>
                    <select class="ai-model-select" id="aiModelSelect" onchange="saveAIModel()">
                        <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash (M√°s R√°pido)</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash (R√°pido)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Estable)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (M√°s Inteligente)</option>
                    </select>
                </div>
            </div>

            <div class="ai-quick-actions">
                <div class="ai-quick-actions-label">Acciones R√°pidas</div>
                <div class="ai-actions">
                    <button class="ai-action-btn" onclick="aiAction('explain')">
                        <span class="icon">üí°</span>
                        <span>Explicar</span>
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('improve')">
                        <span class="icon">‚ú®</span>
                        <span>Mejorar</span>
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('fix')">
                        <span class="icon">üîß</span>
                        <span>Corregir</span>
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('comment')">
                        <span class="icon">üìù</span>
                        <span>Comentarios</span>
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('convert')">
                        <span class="icon">üîÑ</span>
                        <span>Convertir</span>
                    </button>
                    <button class="ai-action-btn" onclick="aiAction('test')">
                        <span class="icon">üß™</span>
                        <span>Tests</span>
                    </button>
                </div>
            </div>

            <div class="ai-chat-container" id="aiChatContainer">
                <div class="ai-empty-state" id="aiEmptyState">
                    <div class="ai-empty-icon">ü§ñ</div>
                    <h4>¬øC√≥mo puedo ayudarte?</h4>
                    <p>Selecciona una acci√≥n arriba o escribe tu propia pregunta sobre el c√≥digo.</p>
                    <div class="ai-suggestions">
                        <button class="ai-suggestion" onclick="aiAction('explain')">Explicar este c√≥digo</button>
                        <button class="ai-suggestion" onclick="aiAction('improve')">Sugerir mejoras</button>
                    </div>
                </div>
            </div>

            <div class="ai-input-area">
                <div class="ai-input-wrapper">
                    <textarea id="aiPrompt" placeholder="Pregunta algo sobre tu c√≥digo..." rows="1" onkeydown="handleAIKeydown(event)"></textarea>
                    <button class="ai-send-btn" onclick="submitAIRequest()" id="aiSubmitBtn">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed (normal for dev)'));
            });
        }
    </script>

    <script>
        let tabs = [];
        let activeTabId = null;
        let tabCounter = 0;
        let editor = null;
        let isDarkMode = true;
        let wordWrap = false;
        let isInitialLoad = true;
        let findOptions = { regex: false, case: false, word: false };
        let searchMarks = [];
        
        // Preview modes: 'none', 'toggle', 'split'
        let previewMode = 'none';
        let isPreviewMode = false;
        let isSplitView = false;

        const languageMap = {
            'text': { name: 'Plain text', icon: 'üìÑ', devicon: '', ext: '.txt' },
            'javascript': { name: 'JavaScript', icon: 'üü®', devicon: 'devicon-javascript-plain', ext: '.js' },
            'python': { name: 'Python', icon: 'üêç', devicon: 'devicon-python-plain', ext: '.py' },
            'sql': { name: 'SQL', icon: 'üóÉÔ∏è', devicon: '', ext: '.sql', class: 'icon-sql' },
            'htmlmixed': { name: 'HTML', icon: 'üåê', devicon: 'devicon-html5-plain', ext: '.html' },
            'css': { name: 'CSS', icon: 'üé®', devicon: 'devicon-css3-plain', ext: '.css' },
            'xml': { name: 'XML', icon: 'üìã', devicon: '', ext: '.xml', class: 'icon-xml' },
            'text/x-java': { name: 'Java', icon: '‚òï', devicon: 'devicon-java-plain', ext: '.java' },
            'text/x-csharp': { name: 'C#', icon: 'üíú', devicon: 'devicon-csharp-plain', ext: '.cs' },
            'text/x-csrc': { name: 'C', icon: 'üîµ', devicon: 'devicon-c-plain', ext: '.c' },
            'text/x-c++src': { name: 'C++', icon: 'üî∑', devicon: 'devicon-cplusplus-plain', ext: '.cpp' },
            'php': { name: 'PHP', icon: 'üêò', devicon: 'devicon-php-plain', ext: '.php' },
            'ruby': { name: 'Ruby', icon: 'üíé', devicon: 'devicon-ruby-plain', ext: '.rb' },
            'go': { name: 'Go', icon: 'üîπ', devicon: 'devicon-go-plain', ext: '.go' },
            'rust': { name: 'Rust', icon: 'ü¶Ä', devicon: 'devicon-rust-plain', ext: '.rs' },
            'perl': { name: 'Perl', icon: 'üê™', devicon: 'devicon-perl-plain', ext: '.pl' },
            'shell': { name: 'Shell', icon: 'üñ•Ô∏è', devicon: 'devicon-bash-plain', ext: '.sh' },
            'powershell': { name: 'PowerShell', icon: 'üí†', devicon: 'devicon-powershell-plain', ext: '.ps1' },
            'yaml': { name: 'YAML', icon: 'üìù', devicon: 'devicon-yaml-plain', ext: '.yml' },
            'markdown': { name: 'Markdown', icon: 'üìë', devicon: 'devicon-markdown-original', ext: '.md' },
            'dockerfile': { name: 'Dockerfile', icon: 'üê≥', devicon: 'devicon-docker-plain', ext: '' },
            'toml': { name: 'TOML', icon: '‚öôÔ∏è', devicon: '', ext: '.toml', class: 'icon-toml' },
            'r': { name: 'R', icon: 'üìä', devicon: 'devicon-r-plain', ext: '.r' },
            'application/json': { name: 'JSON', icon: 'üì¶', devicon: 'devicon-json-plain', ext: '.json' }
        };

        const extToLang = {
            '.js': 'javascript', '.mjs': 'javascript', '.jsx': 'javascript',
            '.ts': 'javascript', '.tsx': 'javascript',
            '.py': 'python', '.pyw': 'python',
            '.sql': 'sql',
            '.html': 'htmlmixed', '.htm': 'htmlmixed',
            '.css': 'css', '.scss': 'css', '.less': 'css',
            '.xml': 'xml', '.svg': 'xml',
            '.java': 'text/x-java',
            '.cs': 'text/x-csharp',
            '.c': 'text/x-csrc', '.h': 'text/x-csrc',
            '.cpp': 'text/x-c++src', '.hpp': 'text/x-c++src', '.cc': 'text/x-c++src',
            '.php': 'php',
            '.rb': 'ruby',
            '.go': 'go',
            '.rs': 'rust',
            '.pl': 'perl', '.pm': 'perl',
            '.sh': 'shell', '.bash': 'shell', '.zsh': 'shell',
            '.ps1': 'powershell',
            '.yml': 'yaml', '.yaml': 'yaml',
            '.md': 'markdown', '.markdown': 'markdown',
            '.toml': 'toml',
            '.r': 'r',
            '.json': 'application/json',
            '.csv': 'text',
            '.tsv': 'text',
            '.txt': 'text',
            '.log': 'text'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initEditor();
            loadFromStorage();
            if (tabs.length === 0) {
                createNewTab();
            }
            setupKeyboardShortcuts();
            setupDragAndDrop();
            loadSavedTheme();
            initTooltips();
        });

        // Save before page closes/refreshes
        window.addEventListener('beforeunload', () => {
            saveToStorage();
        });

        // Also save when tab becomes hidden (more reliable)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                saveToStorage();
            }
        });

        // Drag and Drop support
        function setupDragAndDrop() {
            const editorContainer = document.getElementById('editorContainer');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                editorContainer.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Highlight on drag
            ['dragenter', 'dragover'].forEach(eventName => {
                editorContainer.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                editorContainer.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                editorContainer.classList.add('drag-highlight');
            }
            
            function unhighlight() {
                editorContainer.classList.remove('drag-highlight');
            }
            
            // Handle dropped files
            editorContainer.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const content = event.target.result;
                            const lang = detectLanguage(file.name);
                            createNewTab(file.name, content, lang);
                            showToast(`üìÇ File "${file.name}" loaded`);
                        };
                        reader.readAsText(file);
                    });
                }
            }
        }
        
        // Print function
        function printCode() {
            const content = editor.getValue();
            const tab = tabs.find(t => t.id === activeTabId);
            const langInfo = languageMap[tab?.language] || languageMap['text'];
            const lines = content.split('\n');
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${tab?.name || 'Documento'}</title>
                    <style>
                        @page { margin: 1.5cm; }
                        body { font-family: 'Consolas', monospace; font-size: 10pt; line-height: 1.4; }
                        .header { font-family: Arial, sans-serif; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
                        .header h1 { margin: 0; font-size: 14pt; }
                        .header .info { font-size: 9pt; color: #666; margin-top: 5px; }
                        .code-table { width: 100%; border-collapse: collapse; }
                        .code-table td { padding: 1px 8px; vertical-align: top; }
                        .line-num { color: #999; text-align: right; width: 40px; border-right: 1px solid #ddd; padding-right: 10px; }
                        .code { padding-left: 15px; white-space: pre-wrap; }
                        .footer { margin-top: 20px; font-size: 8pt; color: #999; text-align: center; border-top: 1px solid #ddd; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${langInfo.icon} ${tab?.name || 'Documento'}</h1>
                        <div class="info">${langInfo.name} | ${lines.length} lines | ${content.length} characters | ${new Date().toLocaleString()}</div>
                    </div>
                    <table class="code-table">
                        ${lines.map((line, i) => `<tr><td class="line-num">${i + 1}</td><td class="code">${escapeHtml(line) || ' '}</td></tr>`).join('')}
                    </table>
                    <div class="footer">Notepad++ Sidebar | Impreso: ${new Date().toLocaleString()}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function initEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                mode: 'text',
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: false,
                matchBrackets: true,
                autoCloseBrackets: true,
                autoCloseTags: true,
                foldGutter: true,
                gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
                styleActiveLine: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                autoRefresh: {force: true, delay: 100},
                highlightSelectionMatches: {showToken: /\w/, annotateScrollbar: true},
                keyMap: 'sublime',
                extraKeys: {
                    'Tab': (cm) => cm.execCommand('indentMore'),
                    'Shift-Tab': (cm) => cm.execCommand('indentLess'),
                    'Ctrl-/': () => toggleComment(),
                    'Cmd-/': () => toggleComment(),
                    'Ctrl-D': (cm) => cm.execCommand('selectNextOccurrence'),
                    'Cmd-D': (cm) => cm.execCommand('selectNextOccurrence'),
                    'Ctrl-Shift-L': (cm) => cm.execCommand('splitSelectionByLine'),
                    'Cmd-Shift-L': (cm) => cm.execCommand('splitSelectionByLine'),
                    'Alt-Click': (cm) => { /* multiple cursor on alt+click - handled by sublime keymap */ }
                }
            });

            editor.on('change', () => {
                markModified();
                updateStatus();
                saveToStorage();
            });

            editor.on('cursorActivity', () => {
                updateCursorPos();
            });
            
            // Force refresh after initialization to fix flexbox layout issues
            setTimeout(() => {
                editor.refresh();
                editor.focus();
            }, 100);
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'n':
                            e.preventDefault();
                            createNewTab();
                            break;
                        case 's':
                            e.preventDefault();
                            saveFile();
                            break;
                        case 'o':
                            e.preventDefault();
                            openFile();
                            break;
                        case 'f':
                            e.preventDefault();
                            toggleFind();
                            break;
                        case 'g':
                            e.preventDefault();
                            goToLine();
                            break;
                        case 'w':
                            e.preventDefault();
                            closeTab(activeTabId);
                            break;
                        case 'h':
                            e.preventDefault();
                            toggleFind();
                            document.getElementById('replaceInput').focus();
                            break;
                        case '=':
                        case '+':
                            e.preventDefault();
                            zoomIn();
                            break;
                        case '-':
                            e.preventDefault();
                            zoomOut();
                            break;
                        case '0':
                            e.preventDefault();
                            zoomReset();
                            break;
                        case 'p':
                            e.preventDefault();
                            printCode();
                            break;
                    }
                }
            });
        }

        // Duplicate line (Ctrl+D)
        function duplicateLine() {
            const cursor = editor.getCursor();
            const line = editor.getLine(cursor.line);
            editor.replaceRange('\n' + line, {line: cursor.line, ch: line.length});
            editor.setCursor({line: cursor.line + 1, ch: cursor.ch});
        }

        // Format JSON
        function formatJSON() {
            try {
                const content = editor.getValue();
                const parsed = JSON.parse(content);
                const formatted = JSON.stringify(parsed, null, 2);
                editor.setValue(formatted);
                changeLanguage('application/json');
                showToast('‚ú® JSON formatted successfully');
                flashButton('formatJsonBtn');
            } catch (e) {
                showToast('‚ùå Error: Invalid JSON - ' + e.message, true);
            }
        }

        // Format SQL
        function formatSQL() {
            try {
                const content = editor.getValue();
                const formatted = sqlFormatter.format(content, {
                    language: 'sql',
                    tabWidth: 2,
                    keywordCase: 'upper',
                    linesBetweenQueries: 2
                });
                editor.setValue(formatted);
                changeLanguage('sql');
                showToast('‚ú® SQL formatted successfully');
                flashButton('formatSqlBtn');
            } catch (e) {
                showToast('‚ùå Error formatting SQL: ' + e.message, true);
            }
        }

        function flashButton(btnId) {
            const btn = document.getElementById(btnId);
            btn.classList.add('success');
            setTimeout(() => btn.classList.remove('success'), 500);
        }

        // Word Wrap toggle
        function toggleWordWrap() {
            wordWrap = !wordWrap;
            editor.setOption('lineWrapping', wordWrap);
            document.getElementById('wrapBtn').classList.toggle('active', wordWrap);
            document.getElementById('statusWrap').textContent = wordWrap ? '‚Ü©Ô∏è Wrap' : '';
            localStorage.setItem('notepadWordWrap', wordWrap);
        }

        // Theme selector functions
        let currentTheme = localStorage.getItem('notepadTheme') || 'dracula';
        let lastDarkTheme = 'dracula';
        let lastLightTheme = 'eclipse';
        
        function toggleThemeDropdown() {
            const dropdown = document.getElementById('themeDropdown');
            const btn = document.querySelector('.theme-selector-btn');
            const rect = btn.getBoundingClientRect();
            
            // Calculate position
            let left = rect.left;
            let top = rect.bottom + 4;
            
            // Get dropdown width (estimate if not visible)
            const dropdownWidth = 180;
            const dropdownHeight = Math.min(window.innerHeight * 0.7, 400);
            
            // Adjust if would overflow right edge
            if (left + dropdownWidth > window.innerWidth - 10) {
                left = window.innerWidth - dropdownWidth - 10;
            }
            
            // Adjust if would overflow left edge
            if (left < 10) {
                left = 10;
            }
            
            // Adjust if would overflow bottom
            if (top + dropdownHeight > window.innerHeight - 10) {
                top = rect.top - dropdownHeight - 4;
            }
            
            dropdown.style.top = top + 'px';
            dropdown.style.left = left + 'px';
            
            dropdown.classList.toggle('show');
            
            // Close when clicking outside
            if (dropdown.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', closeThemeDropdownOutside);
                }, 0);
            }
        }
        
        function closeThemeDropdownOutside(e) {
            const dropdown = document.getElementById('themeDropdown');
            const selector = document.querySelector('.theme-selector');
            if (!selector.contains(e.target)) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeThemeDropdownOutside);
            }
        }
        
        function quickToggleTheme() {
            const lightThemes = ['eclipse', 'idea', 'neat', 'solarized light', 'xq-light', 'yeti'];
            if (isDarkMode) {
                setTheme(lastLightTheme, lastLightTheme.charAt(0).toUpperCase() + lastLightTheme.slice(1), '#ffffff');
            } else {
                setTheme(lastDarkTheme, lastDarkTheme.charAt(0).toUpperCase() + lastDarkTheme.slice(1), '#282a36');
            }
        }
        
        function updateQuickThemeIcon() {
            const icon = document.getElementById('quickThemeIcon');
            if (icon) {
                icon.textContent = isDarkMode ? 'üåô' : '‚òÄÔ∏è';
            }
        }
        
        function setTheme(theme, displayName, bgColor) {
            currentTheme = theme;
            editor.setOption('theme', theme);
            
            // Update UI
            document.getElementById('currentThemeName').textContent = displayName;
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.theme === theme) {
                    opt.classList.add('active');
                }
            });
            
            // Toggle light/dark mode based on theme
            const lightThemes = ['eclipse', 'idea', 'neat', 'solarized light', 'xq-light', 'yeti'];
            const wasLightMode = !isDarkMode;
            isDarkMode = !lightThemes.includes(theme);
            
            // Remember last used theme of each type
            if (isDarkMode) {
                lastDarkTheme = theme;
                document.body.classList.remove('light-mode');
            } else {
                lastLightTheme = theme;
                document.body.classList.add('light-mode');
            }
            
            // Update quick toggle icon
            updateQuickThemeIcon();
            
            // Close dropdown
            document.getElementById('themeDropdown').classList.remove('show');
            
            // Save preference
            localStorage.setItem('notepadTheme', theme);
            localStorage.setItem('notepadThemeName', displayName);
            localStorage.setItem('notepadDarkMode', isDarkMode);
            localStorage.setItem('notepadLastDarkTheme', lastDarkTheme);
            localStorage.setItem('notepadLastLightTheme', lastLightTheme);
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('notepadTheme');
            const savedThemeName = localStorage.getItem('notepadThemeName');
            const savedLastDark = localStorage.getItem('notepadLastDarkTheme');
            const savedLastLight = localStorage.getItem('notepadLastLightTheme');
            
            if (savedLastDark) lastDarkTheme = savedLastDark;
            if (savedLastLight) lastLightTheme = savedLastLight;
            
            if (savedTheme) {
                currentTheme = savedTheme;
                editor.setOption('theme', savedTheme);
                
                if (savedThemeName) {
                    document.getElementById('currentThemeName').textContent = savedThemeName;
                }
                
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.remove('active');
                    if (opt.dataset.theme === savedTheme) {
                        opt.classList.add('active');
                    }
                });
                
                const lightThemes = ['eclipse', 'idea', 'neat', 'solarized light', 'xq-light', 'yeti'];
                isDarkMode = !lightThemes.includes(savedTheme);
                
                if (!isDarkMode) {
                    document.body.classList.add('light-mode');
                }
                
                updateQuickThemeIcon();
            }
        }
        
        // Legacy function for compatibility
        function toggleTheme() {
            const lightThemes = ['eclipse', 'idea', 'neat', 'solarized light', 'xq-light', 'yeti'];
            if (isDarkMode) {
                setTheme('eclipse', 'Eclipse', '#ffffff');
            } else {
                setTheme('dracula', 'Dracula', '#282a36');
            }
        }

        function applyTheme() {
            // Now handled by loadSavedTheme
        }

        // Global Search Functions
        function openGlobalSearch() {
            const modal = document.getElementById('globalSearchModal');
            const input = document.getElementById('globalSearchInput');
            modal.classList.add('show');
            input.value = '';
            input.focus();
            updateGlobalSearchResults('');
        }
        
        function closeGlobalSearch() {
            document.getElementById('globalSearchModal').classList.remove('show');
        }
        
        function updateGlobalSearchResults(query) {
            const resultsContainer = document.getElementById('globalSearchResults');
            const statsContainer = document.getElementById('globalSearchStats');
            
            if (!query || query.length < 2) {
                resultsContainer.innerHTML = '<div class="global-search-no-results">Type at least 2 characters to search...</div>';
                statsContainer.textContent = '';
                return;
            }
            
            // Save current tab content before searching
            if (activeTabId) {
                const tab = tabs.find(t => t.id === activeTabId);
                if (tab) {
                    tab.content = editor.getValue();
                }
            }
            
            const results = [];
            const queryLower = query.toLowerCase();
            
            // Search all tabs
            tabs.forEach(tab => {
                const lines = tab.content.split('\n');
                lines.forEach((line, index) => {
                    if (line.toLowerCase().includes(queryLower)) {
                        results.push({
                            tabId: tab.id,
                            tabName: tab.name,
                            lineNumber: index + 1,
                            lineContent: line,
                            query: query
                        });
                    }
                });
            });
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `<div class="global-search-no-results">No results found for "${escapeHtml(query)}"</div>`;
                statsContainer.textContent = '';
                return;
            }
            
            // Limit results for performance
            const limitedResults = results.slice(0, 100);
            
            resultsContainer.innerHTML = limitedResults.map(r => {
                const highlightedContent = highlightMatch(r.lineContent, r.query);
                return `
                    <div class="global-search-result" onclick="goToSearchResult('${r.tabId}', ${r.lineNumber})">
                        <div class="global-search-result-header">
                            <span class="global-search-result-tab">${escapeHtml(r.tabName)}</span>
                            <span class="global-search-result-line">Line ${r.lineNumber}</span>
                        </div>
                        <div class="global-search-result-content">${highlightedContent}</div>
                    </div>
                `;
            }).join('');
            
            statsContainer.textContent = `Found ${results.length} match${results.length !== 1 ? 'es' : ''} in ${new Set(results.map(r => r.tabId)).size} tab${new Set(results.map(r => r.tabId)).size !== 1 ? 's' : ''}`;
            if (results.length > 100) {
                statsContainer.textContent += ' (showing first 100)';
            }
        }
        
        function highlightMatch(text, query) {
            const escaped = escapeHtml(text);
            const queryEscaped = escapeHtml(query);
            const regex = new RegExp(`(${queryEscaped.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escaped.replace(regex, '<mark>$1</mark>');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function goToSearchResult(tabId, lineNumber) {
            closeGlobalSearch();
            switchTab(tabId);
            
            // Go to line after tab switch
            setTimeout(() => {
                editor.setCursor(lineNumber - 1, 0);
                editor.scrollIntoView({line: lineNumber - 1, ch: 0}, 100);
                editor.focus();
                
                // Highlight the line briefly
                editor.addLineClass(lineNumber - 1, 'background', 'search-highlight-line');
                setTimeout(() => {
                    editor.removeLineClass(lineNumber - 1, 'background', 'search-highlight-line');
                }, 2000);
            }, 50);
        }

        // ========== Text Highlighter Functions ==========
        
        let textMarkers = []; // Store all markers for current tab
        const highlighterPopup = document.getElementById('highlighterPopup');

        // Initialize popup button handlers
        document.querySelectorAll('.highlighter-popup .ht-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const color = btn.dataset.color;
                const action = btn.dataset.action;
                
                if (action === 'clear') {
                    clearHighlightAtSelection();
                } else if (color) {
                    applyHighlight(color);
                }
                hideHighlighterPopup();
                editor.focus();
            });
        });

        function showHighlighterPopup() {
            const selection = editor.getSelection();
            if (!selection) return;
            
            // Get cursor coordinates
            const cursor = editor.getCursor('end');
            const coords = editor.cursorCoords(cursor, 'window');
            
            // Position popup above selection
            const popupHeight = 40;
            const popupWidth = 180;
            
            let left = coords.left - (popupWidth / 2);
            let top = coords.top - popupHeight - 8;
            
            // Keep within viewport
            if (left < 10) left = 10;
            if (left + popupWidth > window.innerWidth - 10) {
                left = window.innerWidth - popupWidth - 10;
            }
            if (top < 10) {
                top = coords.bottom + 8; // Show below if not enough space above
            }
            
            highlighterPopup.style.left = left + 'px';
            highlighterPopup.style.top = top + 'px';
            highlighterPopup.classList.add('show');
        }

        function hideHighlighterPopup() {
            highlighterPopup.classList.remove('show');
        }

        function applyHighlight(color) {
            const selections = editor.listSelections();
            selections.forEach(sel => {
                const from = sel.anchor;
                const to = sel.head;
                // Ensure from is before to
                const [start, end] = from.line < to.line || (from.line === to.line && from.ch < to.ch) 
                    ? [from, to] : [to, from];
                
                if (start.line !== end.line || start.ch !== end.ch) {
                    const marker = editor.markText(start, end, {
                        className: `highlight-${color}`,
                        clearOnEnter: false
                    });
                    textMarkers.push({
                        marker,
                        color,
                        from: {line: start.line, ch: start.ch},
                        to: {line: end.line, ch: end.ch}
                    });
                }
            });
            saveHighlightsToTab();
        }

        function clearHighlightAtSelection() {
            const selections = editor.listSelections();
            selections.forEach(sel => {
                const from = sel.anchor;
                const to = sel.head;
                const [start, end] = from.line < to.line || (from.line === to.line && from.ch < to.ch) 
                    ? [from, to] : [to, from];
                
                // Find and clear marks in selection range
                const marks = editor.findMarks(start, end);
                marks.forEach(mark => {
                    mark.clear();
                    textMarkers = textMarkers.filter(m => m.marker !== mark);
                });
            });
            saveHighlightsToTab();
        }

        function clearAllHighlights() {
            textMarkers.forEach(m => m.marker.clear());
            textMarkers = [];
            saveHighlightsToTab();
            showToast('Todos los destacados eliminados');
        }

        function saveHighlightsToTab() {
            if (!activeTabId) return;
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab) {
                tab.highlights = textMarkers.map(m => {
                    const range = m.marker.find();
                    if (range) {
                        return {
                            color: m.color,
                            from: {line: range.from.line, ch: range.from.ch},
                            to: {line: range.to.line, ch: range.to.ch}
                        };
                    }
                    return null;
                }).filter(Boolean);
                saveToStorage();
            }
        }

        function loadHighlightsFromTab() {
            // Clear existing markers
            textMarkers.forEach(m => m.marker.clear());
            textMarkers = [];
            
            if (!activeTabId) return;
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab && tab.highlights) {
                tab.highlights.forEach(h => {
                    const marker = editor.markText(h.from, h.to, {
                        className: `highlight-${h.color}`,
                        clearOnEnter: false
                    });
                    textMarkers.push({
                        marker,
                        color: h.color,
                        from: h.from,
                        to: h.to
                    });
                });
            }
        }

        // Show popup on text selection
        let selectionTimeout = null;
        editor.on('cursorActivity', () => {
            clearTimeout(selectionTimeout);
            const selection = editor.getSelection();
            
            if (selection && selection.length > 0) {
                // Delay showing popup slightly to avoid flickering
                selectionTimeout = setTimeout(() => {
                    if (editor.getSelection()) {
                        showHighlighterPopup();
                    }
                }, 300);
            } else {
                hideHighlighterPopup();
            }
        });

        // Hide popup when clicking outside
        document.addEventListener('mousedown', (e) => {
            if (!highlighterPopup.contains(e.target) && !e.target.closest('.CodeMirror')) {
                hideHighlighterPopup();
            }
        });

        // Highlighter keyboard shortcuts (work even without popup)
        document.addEventListener('keydown', (e) => {
            if (e.altKey && editor.getSelection()) {
                switch(e.key) {
                    case '1': e.preventDefault(); applyHighlight('yellow'); hideHighlighterPopup(); break;
                    case '2': e.preventDefault(); applyHighlight('green'); hideHighlighterPopup(); break;
                    case '3': e.preventDefault(); applyHighlight('blue'); hideHighlighterPopup(); break;
                    case '4': e.preventDefault(); applyHighlight('pink'); hideHighlighterPopup(); break;
                    case '5': e.preventDefault(); applyHighlight('orange'); hideHighlighterPopup(); break;
                    case '0': e.preventDefault(); clearHighlightAtSelection(); hideHighlighterPopup(); break;
                }
            }
        });

        // ========== File System Access API (Ctrl+S) ==========
        
        let currentFileHandle = null;

        async function saveFileDirect() {
            const content = editor.getValue();
            const tab = tabs.find(t => t.id === activeTabId);
            const fileName = tab ? tab.name : 'untitled.txt';
            const lang = tab ? tab.language : 'text';
            
            // If we have a file handle, save directly
            if (currentFileHandle) {
                try {
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    showToast(`Guardado: ${currentFileHandle.name}`);
                    return;
                } catch (err) {
                    console.log('Direct save failed, falling back to Save As');
                    currentFileHandle = null;
                }
            }
            
            // Otherwise, show Save As dialog
            await saveFileAs();
        }

        async function saveFileAs() {
            const content = editor.getValue();
            const tab = tabs.find(t => t.id === activeTabId);
            const fileName = tab ? tab.name : 'untitled.txt';
            const lang = tab ? tab.language : 'text';
            
            // File extension mapping
            const langExtensions = {
                javascript: '.js', typescript: '.ts', jsx: '.jsx', vue: '.vue',
                html: '.html', xml: '.xml', css: '.css', json: '.json',
                python: '.py', java: '.java', csharp: '.cs', php: '.php',
                ruby: '.rb', go: '.go', rust: '.rs', sql: '.sql',
                yaml: '.yaml', toml: '.toml', markdown: '.md', text: '.txt',
                c: '.c', cpp: '.cpp', shell: '.sh', bash: '.sh',
                dockerfile: 'Dockerfile', csv: '.csv'
            };
            
            const ext = langExtensions[lang] || '.txt';
            const suggestedName = fileName.includes('.') ? fileName : fileName + ext;
            
            // Check if File System Access API is supported
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: suggestedName,
                        types: [{
                            description: 'Archivos de Texto',
                            accept: { 'text/plain': [ext] }
                        }]
                    });
                    
                    const writable = await handle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    
                    currentFileHandle = handle;
                    
                    // Update tab name
                    if (tab) {
                        tab.name = handle.name;
                        renderTabs();
                    }
                    
                    showToast(`Guardado: ${handle.name}`);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Save failed:', err);
                    }
                }
            } else {
                // Fallback for browsers without File System Access API
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = suggestedName;
                a.click();
                URL.revokeObjectURL(url);
                showToast(`Descargado: ${suggestedName}`);
            }
        }

        // Override Ctrl+S and Ctrl+Shift+S
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (e.shiftKey) {
                    saveFileAs();
                } else {
                    saveFileDirect();
                }
            }
        });

        // ========== Asistente IA Functions ==========
        
        // AI Chat State
        let aiChatHistory = [];
        let lastAIResponse = '';
        let isAITyping = false;
        let selectedAIModel = localStorage.getItem('aiModel') || 'gemini-2.5-flash-preview-05-20';

        // Language to extension mapping for code export
        const langExtensionMap = {
            javascript: '.js', js: '.js', typescript: '.ts', ts: '.ts',
            jsx: '.jsx', tsx: '.tsx', vue: '.vue',
            html: '.html', htm: '.html', xml: '.xml', svg: '.svg',
            css: '.css', scss: '.scss', sass: '.sass', less: '.less',
            json: '.json', yaml: '.yaml', yml: '.yml', toml: '.toml',
            python: '.py', py: '.py', java: '.java', kotlin: '.kt',
            csharp: '.cs', cs: '.cs', fsharp: '.fs',
            php: '.php', ruby: '.rb', rb: '.rb',
            go: '.go', rust: '.rs', rs: '.rs',
            swift: '.swift', objc: '.m', objectivec: '.m',
            sql: '.sql', mysql: '.sql', postgresql: '.sql', pgsql: '.sql',
            c: '.c', cpp: '.cpp', 'c++': '.cpp', h: '.h',
            shell: '.sh', bash: '.sh', sh: '.sh', zsh: '.zsh', powershell: '.ps1',
            dockerfile: 'Dockerfile', docker: 'Dockerfile',
            markdown: '.md', md: '.md', text: '.txt', txt: '.txt',
            csv: '.csv', ini: '.ini', conf: '.conf',
            r: '.r', perl: '.pl', lua: '.lua', scala: '.scala',
            elixir: '.ex', erlang: '.erl', haskell: '.hs', clojure: '.clj'
        };

        // Load AI chat history from localStorage
        function loadAIChatHistory() {
            const saved = localStorage.getItem('aiChatHistory');
            if (saved) {
                try {
                    aiChatHistory = JSON.parse(saved);
                    renderAIChatHistory();
                } catch (e) {
                    aiChatHistory = [];
                }
            }
        }

        // Save AI chat history to localStorage
        function saveAIChatHistory() {
            // Keep only last 50 messages to avoid localStorage limits
            const toSave = aiChatHistory.slice(-50);
            localStorage.setItem('aiChatHistory', JSON.stringify(toSave));
        }

        // Render chat history on panel open
        function renderAIChatHistory() {
            const container = document.getElementById('aiChatContainer');
            const emptyState = document.getElementById('aiEmptyState');
            
            if (aiChatHistory.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            aiChatHistory.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `ai-message ${msg.role}`;
                msgDiv.innerHTML = msg.role === 'assistant' 
                    ? formatAIResponse(msg.content)
                    : `<div class="ai-message-content">${escapeHtml(msg.content)}</div>`;
                container.appendChild(msgDiv);
            });
            
            container.scrollTop = container.scrollHeight;
            
            // Apply syntax highlighting to code blocks
            container.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
        }

        // Save AI model selection
        function saveAIModel() {
            selectedAIModel = document.getElementById('aiModelSelect').value;
            localStorage.setItem('aiModel', selectedAIModel);
            showToast(`Modelo: ${selectedAIModel.split('-').slice(0,3).join(' ')}`);
        }

        // Load AI model on startup
        function loadAIModel() {
            const saved = localStorage.getItem('aiModel');
            if (saved) {
                selectedAIModel = saved;
                const select = document.getElementById('aiModelSelect');
                if (select) select.value = saved;
            }
        }

        function openAIPanel() {
            document.getElementById('aiModal').classList.add('show');
            document.getElementById('aiPrompt').focus();
            
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('geminiApiKey').value = savedKey;
            } else {
                document.getElementById('aiSettings').classList.add('show');
            }
            
            // Load saved model
            loadAIModel();
            
            // Load chat history
            loadAIChatHistory();
            
            autoResizeTextarea(document.getElementById('aiPrompt'));
        }
        
        function closeAIPanel() {
            document.getElementById('aiModal').classList.remove('show');
        }
        
        function toggleAISettings() {
            document.getElementById('aiSettings').classList.toggle('show');
        }
        
        function saveGeminiKey() {
            const key = document.getElementById('geminiApiKey').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                showToast('üîë ¬°Clave API guardada!');
                document.getElementById('aiSettings').classList.remove('show');
            }
        }
        
        function clearAIChat() {
            aiChatHistory = [];
            localStorage.removeItem('aiChatHistory');
            const chatContainer = document.getElementById('aiChatContainer');
            chatContainer.innerHTML = `
                <div class="ai-empty-state" id="aiEmptyState">
                    <div class="ai-empty-icon">ü§ñ</div>
                    <h4>¬øC√≥mo puedo ayudarte?</h4>
                    <p>Selecciona una acci√≥n arriba o escribe tu propia pregunta sobre el c√≥digo.</p>
                    <div class="ai-suggestions">
                        <button class="ai-suggestion" onclick="aiAction('explain')">Explicar este c√≥digo</button>
                        <button class="ai-suggestion" onclick="aiAction('improve')">Sugerir mejoras</button>
                    </div>
                </div>
            `;
            showToast('üóëÔ∏è Chat limpiado');
        }
        
        function addMessageToChat(role, content, showActions = false) {
            const chatContainer = document.getElementById('aiChatContainer');
            const emptyState = document.getElementById('aiEmptyState');
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;
            
            const avatar = role === 'assistant' ? '‚ú®' : 'üë§';
            const formattedContent = role === 'assistant' ? formatAIResponse(content) : escapeHtml(content);
            
            messageDiv.innerHTML = `
                <div class="ai-message-avatar">${avatar}</div>
                <div class="ai-message-content">${formattedContent}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            
            // Apply syntax highlighting to code blocks
            messageDiv.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
            
            if (role === 'assistant' && showActions) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'ai-response-actions';
                actionsDiv.innerHTML = `
                    <button onclick="insertAIResponse()">üìã Insertar</button>
                    <button onclick="replaceWithAIResponse()">üîÑ Reemplazar</button>
                    <button onclick="copyAIResponse()">üìë Copiar</button>
                `;
                chatContainer.appendChild(actionsDiv);
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
            aiChatHistory.push({ role, content });
            saveAIChatHistory();
        }
        
        function showTypingIndicator() {
            const chatContainer = document.getElementById('aiChatContainer');
            const emptyState = document.getElementById('aiEmptyState');
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-typing';
            typingDiv.id = 'aiTypingIndicator';
            typingDiv.innerHTML = `
                <div class="ai-message-avatar" style="background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%); color: white;">‚ú®</div>
                <div class="ai-typing-dots">
                    <div class="ai-typing-dot"></div>
                    <div class="ai-typing-dot"></div>
                    <div class="ai-typing-dot"></div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('aiTypingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function handleAIKeydown(event) {
            const textarea = event.target;
            autoResizeTextarea(textarea);
            
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                submitAIRequest();
            }
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function aiAction(action) {
            const selection = editor.getSelection();
            const code = selection || editor.getValue();
            
            if (!code.trim()) {
                showToast('‚ö†Ô∏è No hay c√≥digo para analizar');
                return;
            }
            
            const tab = tabs.find(t => t.id === activeTabId);
            const lang = languageMap[tab?.language]?.name || 'code';
            
            const prompts = {
                'explain': `Explica este c√≥digo ${lang} en t√©rminos simples. ¬øQu√© hace paso a paso?\n\n\`\`\`${lang}\n${code}\n\`\`\``,
                'improve': `Mejora este c√≥digo ${lang}. Hazlo m√°s eficiente, legible y sigue las mejores pr√°cticas. Devuelve solo el c√≥digo mejorado con breves comentarios explicando los cambios.\n\n\`\`\`${lang}\n${code}\n\`\`\``,
                'fix': `Encuentra y corrige errores en este c√≥digo ${lang}. Explica qu√© estaba mal y devuelve el c√≥digo corregido.\n\n\`\`\`${lang}\n${code}\n\`\`\``,
                'comment': `Agrega comentarios claros y √∫tiles a este c√≥digo ${lang}. Devuelve el c√≥digo con los comentarios agregados.\n\n\`\`\`${lang}\n${code}\n\`\`\``,
                'convert': `Convierte este c√≥digo a Python. Devuelve solo el c√≥digo convertido.\n\n\`\`\`${lang}\n${code}\n\`\`\``,
                'test': `Genera pruebas unitarias para este c√≥digo ${lang}. Usa el framework de pruebas apropiado.\n\n\`\`\`${lang}\n${code}\n\`\`\``
            };
            
            document.getElementById('aiPrompt').value = prompts[action];
            submitAIRequest();
        }
        
        async function submitAIRequest() {
            const apiKey = localStorage.getItem('gemini_api_key');
            
            if (!apiKey) {
                showToast('‚ö†Ô∏è Por favor ingresa tu clave API de Gemini primero');
                document.getElementById('aiSettings').classList.add('show');
                document.getElementById('geminiApiKey').focus();
                return;
            }
            
            let prompt = document.getElementById('aiPrompt').value.trim();
            
            if (!prompt) {
                const selection = editor.getSelection();
                const code = selection || editor.getValue();
                if (code.trim()) {
                    prompt = `Ay√∫dame con este c√≥digo:\n\n\`\`\`\n${code}\n\`\`\``;
                } else {
                    showToast('‚ö†Ô∏è Por favor ingresa un prompt o selecciona c√≥digo');
                    return;
                }
            }
            
            addMessageToChat('user', prompt);
            
            document.getElementById('aiPrompt').value = '';
            autoResizeTextarea(document.getElementById('aiPrompt'));
            
            showTypingIndicator();
            document.getElementById('aiSubmitBtn').disabled = true;
            isAITyping = true;
            
            try {
                // Use selected model
                const model = selectedAIModel || 'gemini-2.5-flash-preview-05-20';
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 4096
                            }
                        })
                    }
                );
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'Error de API');
                }
                
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No se gener√≥ respuesta';
                lastAIResponse = aiText;
                
                hideTypingIndicator();
                addMessageToChat('assistant', aiText, true);
                
            } catch (error) {
                console.error('Error de IA:', error);
                hideTypingIndicator();
                addMessageToChat('assistant', `‚ùå Error: ${error.message}`, false);
                
                if (error.message.includes('API key')) {
                    showToast('‚ö†Ô∏è Clave API inv√°lida. Por favor verifica tu clave.');
                } else {
                    showToast('‚ùå La solicitud de IA fall√≥');
                }
            } finally {
                document.getElementById('aiSubmitBtn').disabled = false;
                isAITyping = false;
            }
        }
        
        function formatAIResponse(text) {
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Convert code blocks with enhanced styling and export buttons
            formatted = formatted.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
                const displayLang = lang || 'text';
                const ext = langExtensionMap[lang.toLowerCase()] || '.txt';
                const fileName = `code${ext}`;
                
                return `<div class="ai-code-block">
                    <div class="ai-code-header">
                        <span class="ai-code-lang">${displayLang}</span>
                        <div class="ai-code-actions">
                            <button class="ai-code-btn" onclick="copyCodeBlock('${codeId}')" title="Copiar c√≥digo">üìã Copiar</button>
                            <button class="ai-code-btn" onclick="insertCodeBlock('${codeId}')" title="Insertar en editor">‚û°Ô∏è Insertar</button>
                            <button class="ai-code-btn primary" onclick="downloadCodeBlock('${codeId}', '${fileName}')" title="Descargar como ${ext}">üíæ ${ext}</button>
                        </div>
                    </div>
                    <pre><code id="${codeId}" class="language-${displayLang}">${code.trim()}</code></pre>
                </div>`;
            });
            
            // Convert inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            // Convert bold
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert italic
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Convert newlines (but not inside code blocks)
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
        
        function copyCodeBlock(codeId) {
            const codeEl = document.getElementById(codeId);
            if (codeEl) {
                navigator.clipboard.writeText(codeEl.textContent).then(() => {
                    showToast('üìã ¬°C√≥digo copiado!');
                });
            }
        }

        function insertCodeBlock(codeId) {
            const codeEl = document.getElementById(codeId);
            if (codeEl) {
                editor.replaceSelection(codeEl.textContent);
                closeAIPanel();
                showToast('‚û°Ô∏è ¬°C√≥digo insertado!');
            }
        }

        function downloadCodeBlock(codeId, fileName) {
            const codeEl = document.getElementById(codeId);
            if (codeEl) {
                const content = codeEl.textContent;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
                showToast(`üíæ Descargado: ${fileName}`);
            }
        }
        
        function insertAIResponse() {
            if (lastAIResponse) {
                const codeMatch = lastAIResponse.match(/```[\w]*\n([\s\S]*?)```/);
                const textToInsert = codeMatch ? codeMatch[1].trim() : lastAIResponse;
                
                editor.replaceSelection(textToInsert);
                closeAIPanel();
                showToast('üìã ¬°C√≥digo insertado!');
            }
        }
        
        function replaceWithAIResponse() {
            if (lastAIResponse) {
                const codeMatch = lastAIResponse.match(/```[\w]*\n([\s\S]*?)```/);
                const textToInsert = codeMatch ? codeMatch[1].trim() : lastAIResponse;
                
                if (editor.getSelection()) {
                    editor.replaceSelection(textToInsert);
                } else {
                    editor.setValue(textToInsert);
                }
                closeAIPanel();
                showToast('üîÑ ¬°C√≥digo reemplazado!');
            }
        }
        
        function copyAIResponse() {
            if (lastAIResponse) {
                const codeMatch = lastAIResponse.match(/```[\w]*\n([\s\S]*?)```/);
                const textToCopy = codeMatch ? codeMatch[1].trim() : lastAIResponse;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('üìë ¬°Copiado al portapapeles!');
                });
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('aiModal').classList.contains('show')) {
                closeAIPanel();
            }
        });

        // Markdown Preview functions
        
        function resetAllPreviewModes() {
            const cmElement = document.querySelector('.CodeMirror');
            const previewEl = document.getElementById('mdPreview');
            const editorContainer = document.getElementById('editorContainer');
            const toggleBtn = document.getElementById('mdPreviewToggle');
            const splitBtn = document.getElementById('splitViewBtn');
            
            // Reset states
            isPreviewMode = false;
            isSplitView = false;
            previewMode = 'none';
            
            // Reset UI
            cmElement.style.display = '';
            previewEl.classList.remove('active');
            editorContainer.classList.remove('split-view');
            editorContainer.classList.remove('toggle-preview');
            toggleBtn.classList.remove('active');
            splitBtn.classList.remove('active');
            
            editor.refresh();
        }

        function toggleSplitView() {
            const editorContainer = document.getElementById('editorContainer');
            const previewEl = document.getElementById('mdPreview');
            const splitBtn = document.getElementById('splitViewBtn');
            const toggleBtn = document.getElementById('mdPreviewToggle');
            const cmElement = document.querySelector('.CodeMirror');
            
            // If toggle preview is active, disable it first
            if (isPreviewMode) {
                isPreviewMode = false;
                cmElement.style.display = '';
                editorContainer.classList.remove('toggle-preview');
                toggleBtn.classList.remove('active');
            }
            
            isSplitView = !isSplitView;
            
            if (isSplitView) {
                previewMode = 'split';
                editorContainer.classList.add('split-view');
                splitBtn.classList.add('active');
                previewEl.classList.add('active');
                
                // Update preview content
                updateSplitPreview();
                
                // Setup live update on editor changes
                editor.on('change', updateSplitPreview);
                
                showToast('üìñ Split View enabled');
                editor.refresh();
            } else {
                previewMode = 'none';
                editorContainer.classList.remove('split-view');
                splitBtn.classList.remove('active');
                previewEl.classList.remove('active');
                
                // Remove live update listener
                editor.off('change', updateSplitPreview);
                
                editor.refresh();
                editor.focus();
            }
        }

        function updateSplitPreview() {
            if (isSplitView) {
                const content = editor.getValue();
                const previewEl = document.getElementById('mdPreview');
                previewEl.innerHTML = marked.parse(content);
            }
        }

        function toggleMdPreview() {
            const cmElement = document.querySelector('.CodeMirror');
            const previewEl = document.getElementById('mdPreview');
            const toggleBtn = document.getElementById('mdPreviewToggle');
            const splitBtn = document.getElementById('splitViewBtn');
            const editorContainer = document.getElementById('editorContainer');
            
            // If split view is active, disable it first
            if (isSplitView) {
                isSplitView = false;
                editorContainer.classList.remove('split-view');
                splitBtn.classList.remove('active');
                editor.off('change', updateSplitPreview);
            }
            
            isPreviewMode = !isPreviewMode;
            
            if (isPreviewMode) {
                previewMode = 'toggle';
                // Show preview, hide editor
                const content = editor.getValue();
                previewEl.innerHTML = marked.parse(content);
                cmElement.style.display = 'none';
                editorContainer.classList.add('toggle-preview');
                previewEl.classList.add('active');
                toggleBtn.classList.add('active');
                showToast('üëÅÔ∏è Preview mode - Click again to edit');
            } else {
                previewMode = 'none';
                // Show editor, hide preview
                cmElement.style.display = '';
                editorContainer.classList.remove('toggle-preview');
                previewEl.classList.remove('active');
                toggleBtn.classList.remove('active');
                editor.refresh();
                editor.focus();
            }
        }

        function openPreviewModal() {
            const content = editor.getValue();
            const tab = tabs.find(t => t.id === activeTabId);
            
            document.getElementById('previewModalTitle').textContent = tab?.name || 'Preview';
            document.getElementById('previewModalBody').innerHTML = marked.parse(content);
            document.getElementById('previewModal').classList.add('active');
        }

        function closePreviewModal(event) {
            if (!event || event.target.id === 'previewModal') {
                document.getElementById('previewModal').classList.remove('active');
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('previewModal');
                if (modal.classList.contains('active')) {
                    closePreviewModal();
                }
            }
        });

        // Split View Resizer functionality
        function setupSplitResizer() {
            const resizer = document.getElementById('splitResizer');
            const editorContainer = document.getElementById('editorContainer');
            const editorWrapper = document.getElementById('splitEditorWrapper');
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', (e) => {
                if (!isSplitView) return;
                
                isResizing = true;
                startX = e.clientX;
                startWidth = editorWrapper.offsetWidth;
                
                resizer.classList.add('dragging');
                editorContainer.classList.add('resizing');
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                
                e.preventDefault();
            });

            function handleMouseMove(e) {
                if (!isResizing) return;
                
                const containerWidth = editorContainer.offsetWidth;
                const dx = e.clientX - startX;
                let newWidth = startWidth + dx;
                
                // Enforce min/max limits (20% - 80%)
                const minWidth = containerWidth * 0.2;
                const maxWidth = containerWidth * 0.8;
                
                if (newWidth < minWidth) newWidth = minWidth;
                if (newWidth > maxWidth) newWidth = maxWidth;
                
                // Apply new width
                editorWrapper.style.width = newWidth + 'px';
                
                // Refresh CodeMirror to prevent cursor issues
                if (editor) {
                    editor.refresh();
                }
            }

            function handleMouseUp() {
                if (!isResizing) return;
                
                isResizing = false;
                resizer.classList.remove('dragging');
                editorContainer.classList.remove('resizing');
                
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                // Final refresh
                if (editor) {
                    editor.refresh();
                }
            }

            // Touch support for mobile
            resizer.addEventListener('touchstart', (e) => {
                if (!isSplitView) return;
                
                isResizing = true;
                startX = e.touches[0].clientX;
                startWidth = editorWrapper.offsetWidth;
                
                resizer.classList.add('dragging');
                editorContainer.classList.add('resizing');
                
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
                
                e.preventDefault();
            });

            function handleTouchMove(e) {
                if (!isResizing) return;
                
                const containerWidth = editorContainer.offsetWidth;
                const dx = e.touches[0].clientX - startX;
                let newWidth = startWidth + dx;
                
                const minWidth = containerWidth * 0.2;
                const maxWidth = containerWidth * 0.8;
                
                if (newWidth < minWidth) newWidth = minWidth;
                if (newWidth > maxWidth) newWidth = maxWidth;
                
                editorWrapper.style.width = newWidth + 'px';
                
                if (editor) {
                    editor.refresh();
                }
            }

            function handleTouchEnd() {
                if (!isResizing) return;
                
                isResizing = false;
                resizer.classList.remove('dragging');
                editorContainer.classList.remove('resizing');
                
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
                
                if (editor) {
                    editor.refresh();
                }
            }
        }

        // Initialize resizer after DOM is ready
        document.addEventListener('DOMContentLoaded', setupSplitResizer);

        function createNewTab(name = null, content = '', lang = 'text') {
            tabCounter++;
            const id = 'tab-' + tabCounter;
            const tabName = name || `sin-titulo-${tabCounter}.txt`;
            
            tabs.push({
                id: id,
                name: tabName,
                content: content,
                language: lang,
                modified: false
            });

            renderTabs();
            switchTab(id);
            saveToStorage();
        }

        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            const addBtn = container.querySelector('.new-tab-btn');
            
            // Remove existing tabs and groups
            container.querySelectorAll('.tab, .tab-group').forEach(t => t.remove());

            // Group tabs by groupId
            const groups = {};
            const ungrouped = [];
            
            tabs.forEach(tab => {
                if (tab.groupId) {
                    if (!groups[tab.groupId]) {
                        groups[tab.groupId] = {
                            id: tab.groupId,
                            name: tab.groupName || '',
                            color: tab.groupColor || 'blue',
                            collapsed: tab.groupCollapsed || false,
                            tabs: []
                        };
                    }
                    groups[tab.groupId].tabs.push(tab);
                } else {
                    ungrouped.push(tab);
                }
            });

            // Render grouped tabs
            Object.values(groups).forEach(group => {
                const groupEl = document.createElement('div');
                groupEl.className = 'tab-group' + (group.collapsed ? ' collapsed' : '');
                groupEl.dataset.groupId = group.id;
                groupEl.dataset.color = group.color;
                
                const headerEl = document.createElement('div');
                headerEl.className = 'tab-group-header';
                headerEl.innerHTML = `
                    <span class="group-collapse">‚ñº</span>
                    <span class="group-label">${group.name || group.tabs.length}</span>
                `;
                headerEl.onclick = () => toggleGroupCollapse(group.id);
                headerEl.oncontextmenu = (e) => showGroupContextMenu(e, group.id);
                groupEl.appendChild(headerEl);
                
                const tabsContainer = document.createElement('div');
                tabsContainer.className = 'tab-group-tabs';
                
                group.tabs.forEach(tab => {
                    const tabEl = createTabElement(tab);
                    tabsContainer.appendChild(tabEl);
                });
                
                groupEl.appendChild(tabsContainer);
                container.insertBefore(groupEl, addBtn);
            });

            // Render ungrouped tabs
            ungrouped.forEach(tab => {
                const tabEl = createTabElement(tab);
                container.insertBefore(tabEl, addBtn);
            });
        }

        function createTabElement(tab) {
            const langInfo = languageMap[tab.language] || languageMap['text'];
            const tabEl = document.createElement('div');
            tabEl.className = 'tab' + (tab.id === activeTabId ? ' active' : '') + (tab.modified ? ' tab-modified' : '');
            tabEl.dataset.tabId = tab.id;
            tabEl.draggable = true;
            
            let iconHtml;
            if (langInfo.devicon) {
                iconHtml = `<i class="${langInfo.devicon}"></i>`;
            } else {
                iconHtml = `<span class="${langInfo.class || ''}">${langInfo.icon}</span>`;
            }
            
            tabEl.innerHTML = `
                <span class="tab-icon">${iconHtml}</span>
                <span class="tab-name" title="${tab.name}">${tab.name}</span>
                <span class="tab-close" onclick="event.stopPropagation(); closeTab('${tab.id}')">‚úï</span>
            `;
            
            // Click events
            tabEl.onclick = () => switchTab(tab.id);
            tabEl.ondblclick = () => showRenameModal(tab.id);
            tabEl.oncontextmenu = (e) => showTabContextMenu(e, tab.id);
            
            // Drag events
            tabEl.ondragstart = (e) => handleTabDragStart(e, tab.id);
            tabEl.ondragend = handleTabDragEnd;
            tabEl.ondragover = (e) => handleTabDragOver(e, tabEl);
            tabEl.ondragleave = (e) => handleTabDragLeave(tabEl);
            tabEl.ondrop = (e) => handleTabDrop(e, tab.id);
            
            return tabEl;
        }

        // Drag and Drop functions
        let draggedTabId = null;

        function handleTabDragStart(e, tabId) {
            draggedTabId = tabId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', tabId);
        }

        function handleTabDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('drag-over', 'drag-over-right');
            });
            draggedTabId = null;
        }

        function handleTabDragOver(e, tabEl) {
            e.preventDefault();
            if (!draggedTabId || tabEl.dataset.tabId === draggedTabId) return;
            
            const rect = tabEl.getBoundingClientRect();
            const midpoint = rect.left + rect.width / 2;
            
            tabEl.classList.remove('drag-over', 'drag-over-right');
            if (e.clientX < midpoint) {
                tabEl.classList.add('drag-over');
            } else {
                tabEl.classList.add('drag-over-right');
            }
        }

        function handleTabDragLeave(tabEl) {
            tabEl.classList.remove('drag-over', 'drag-over-right');
        }

        function handleTabDrop(e, targetTabId) {
            e.preventDefault();
            if (!draggedTabId || draggedTabId === targetTabId) return;

            const draggedIndex = tabs.findIndex(t => t.id === draggedTabId);
            const targetIndex = tabs.findIndex(t => t.id === targetTabId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;

            // Get target tab element to check drop position
            const targetEl = document.querySelector(`[data-tab-id="${targetTabId}"]`);
            const rect = targetEl.getBoundingClientRect();
            const midpoint = rect.left + rect.width / 2;
            const insertAfter = e.clientX >= midpoint;

            // Remove dragged tab from array
            const [draggedTab] = tabs.splice(draggedIndex, 1);
            
            // Find new target index (may have shifted)
            let newTargetIndex = tabs.findIndex(t => t.id === targetTabId);
            
            // Insert at correct position
            if (insertAfter) {
                tabs.splice(newTargetIndex + 1, 0, draggedTab);
            } else {
                tabs.splice(newTargetIndex, 0, draggedTab);
            }

            // Copy group info from target if dropping into a group
            const targetTab = tabs.find(t => t.id === targetTabId);
            if (targetTab.groupId) {
                draggedTab.groupId = targetTab.groupId;
                draggedTab.groupName = targetTab.groupName;
                draggedTab.groupColor = targetTab.groupColor;
            }

            renderTabs();
            saveToStorage();
            showToast('üìë Tab reordered');
        }

        // Tab Groups functions
        let tabGroupCounter = 0;

        function createTabGroup(tabId, color = 'blue') {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            tabGroupCounter++;
            const groupId = 'group-' + tabGroupCounter;
            const groupName = prompt('Group name (optional):', '') || '';
            
            tab.groupId = groupId;
            tab.groupName = groupName;
            tab.groupColor = color;
            tab.groupCollapsed = false;
            
            renderTabs();
            saveToStorage();
            showToast('üìÅ Group created');
        }

        function removeFromGroup(tabId) {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            delete tab.groupId;
            delete tab.groupName;
            delete tab.groupColor;
            delete tab.groupCollapsed;
            
            renderTabs();
            saveToStorage();
            showToast('üì§ Tab removed from group');
        }

        function toggleGroupCollapse(groupId) {
            tabs.forEach(tab => {
                if (tab.groupId === groupId) {
                    tab.groupCollapsed = !tab.groupCollapsed;
                }
            });
            renderTabs();
            saveToStorage();
        }

        function setGroupColor(tabId, color) {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab || !tab.groupId) return;
            
            tabs.forEach(t => {
                if (t.groupId === tab.groupId) {
                    t.groupColor = color;
                }
            });
            
            renderTabs();
            saveToStorage();
        }

        function renameGroup(groupId) {
            const tab = tabs.find(t => t.groupId === groupId);
            if (!tab) return;
            
            const newName = prompt('New nombre del grupo:', tab.groupName || '');
            if (newName === null) return;
            
            tabs.forEach(t => {
                if (t.groupId === groupId) {
                    t.groupName = newName;
                }
            });
            
            renderTabs();
            saveToStorage();
        }

        // Context menu functions
        let contextMenuTabId = null;

        function showTabContextMenu(e, tabId) {
            e.preventDefault();
            contextMenuTabId = tabId;
            
            const menu = document.getElementById('tabContextMenu');
            const tab = tabs.find(t => t.id === tabId);
            
            // Show/hide remove from group option
            const removeItem = document.getElementById('removeFromGroupItem');
            removeItem.style.display = tab.groupId ? 'flex' : 'none';
            
            // Position menu
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.add('active');
            
            // Close menu on click outside
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu);
            }, 0);
        }

        function showGroupContextMenu(e, groupId) {
            e.preventDefault();
            const tab = tabs.find(t => t.groupId === groupId);
            if (tab) {
                showTabContextMenu(e, tab.id);
            }
        }

        function closeContextMenu() {
            document.getElementById('tabContextMenu').classList.remove('active');
            document.removeEventListener('click', closeContextMenu);
        }

        function contextMenuAction(action, param) {
            closeContextMenu();
            
            switch(action) {
                case 'rename':
                    showRenameModal(contextMenuTabId);
                    break;
                case 'duplicate':
                    duplicateTab(contextMenuTabId);
                    break;
                case 'newGroup':
                    createTabGroup(contextMenuTabId);
                    break;
                case 'removeFromGroup':
                    removeFromGroup(contextMenuTabId);
                    break;
                case 'setColor':
                    setGroupColor(contextMenuTabId, param);
                    break;
                case 'close':
                    closeTab(contextMenuTabId);
                    break;
                case 'closeOthers':
                    closeOtherTabs(contextMenuTabId);
                    break;
            }
        }

        function duplicateTab(tabId) {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            tabCounter++;
            const newTab = {
                id: 'tab-' + tabCounter,
                name: tab.name + ' (copy)',
                content: tab.content,
                language: tab.language,
                modified: false
            };
            
            const index = tabs.findIndex(t => t.id === tabId);
            tabs.splice(index + 1, 0, newTab);
            
            switchTab(newTab.id);
            showToast('üìã Tab duplicated');
        }

        function closeOtherTabs(keepTabId) {
            const tabsToClose = tabs.filter(t => t.id !== keepTabId);
            if (tabsToClose.some(t => t.modified)) {
                if (!confirm('Close all other tabs? Hay cambios without saving.')) return;
            }
            
            tabs = tabs.filter(t => t.id === keepTabId);
            if (activeTabId !== keepTabId) {
                switchTab(keepTabId);
            } else {
                renderTabs();
            }
            saveToStorage();
            showToast('üóëÔ∏è Other tabs closed');
        }

        function switchTab(id) {
            if (activeTabId && !isInitialLoad) {
                const currentTab = tabs.find(t => t.id === activeTabId);
                if (currentTab) {
                    currentTab.content = editor.getValue();
                    saveHighlightsToTab(); // Save current highlights before switching
                }
            }

            // Clear current file handle when switching tabs
            currentFileHandle = null;

            activeTabId = id;
            const tab = tabs.find(t => t.id === id);
            
            if (tab) {
                editor.setValue(tab.content);
                editor.setOption('mode', tab.language);
                document.getElementById('languageSelect').value = tab.language;
                document.getElementById('statusFile').textContent = tab.name;
                const langInfo = languageMap[tab.language] || languageMap['text'];
                document.getElementById('statusLangIcon').textContent = langInfo.icon;
                document.getElementById('statusLangName').textContent = langInfo.name;
                editor.clearHistory();
                
                // Load highlights for this tab
                loadHighlightsFromTab();
            }

            renderTabs();
            updateStatus();
            // Use setTimeout to allow DOM to update before refresh
            setTimeout(() => {
                editor.refresh();
                editor.focus();
            }, 1);
        }

        function closeTab(id) {
            const index = tabs.findIndex(t => t.id === id);
            if (index === -1) return;

            const tab = tabs[index];
            if (tab.modified) {
                if (!confirm(`Close "${tab.name}" without saving?`)) return;
            }

            tabs.splice(index, 1);

            if (tabs.length === 0) {
                createNewTab();
            } else if (id === activeTabId) {
                const newIndex = Math.min(index, tabs.length - 1);
                switchTab(tabs[newIndex].id);
            } else {
                renderTabs();
            }
            saveToStorage();
        }

        function markModified() {
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab && !tab.modified) {
                tab.modified = true;
                renderTabs();
            }
        }

        function updateCursorPos() {
            const pos = editor.getCursor();
            document.getElementById('statusPos').textContent = `Ln ${pos.line + 1}, Col ${pos.ch + 1}`;
            
            const sel = editor.getSelection();
            document.getElementById('statusSel').textContent = sel ? `(${sel.length} sel)` : '';
            
            // Update multiple cursores indicator
            const selections = editor.listSelections();
            const cursorCount = selections.length;
            const cursorIndicator = document.getElementById('statusCursors');
            const cursorCountEl = document.getElementById('cursorCount');
            
            if (cursorCount > 1) {
                cursorIndicator.style.display = 'inline';
                cursorCountEl.textContent = cursorCount + ' cursores';
            } else {
                cursorIndicator.style.display = 'none';
            }
        }

        function updateStatus() {
            const content = editor.getValue();
            const lines = content.split('\n').length;
            const words = content.split(/\s+/).filter(w => w).length;
            document.getElementById('statusLength').textContent = `${lines} lines | ${words} words | ${content.length} chars`;
        }

        function changeLanguage(lang) {
            editor.setOption('mode', lang);
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab) {
                tab.language = lang;
                const langInfo = languageMap[lang] || languageMap['text'];
                document.getElementById('statusLangIcon').textContent = langInfo.icon;
                document.getElementById('statusLangName').textContent = langInfo.name;
                document.getElementById('languageSelect').value = lang;
                renderTabs();
                saveToStorage();
            }
        }

        function changeFontSize(size) {
            localStorage.setItem('notepadFontSize', size);
            // Apply font size through zoom system to maintain zoom level
            updateZoom();
        }

        // Zoom functions
        let currentZoom = 100;
        const minZoom = 50;
        const maxZoom = 150;
        const zoomStep = 10;

        function getBaseFontSize() {
            // Get current font-size from selector, default to 13
            const selector = document.getElementById('fontSizeSelect');
            return selector ? parseInt(selector.value) || 13 : 13;
        }

        function updateZoom() {
            // Calculate font size: base font * zoom percentage
            const baseFontSize = getBaseFontSize();
            const newFontSize = Math.round(baseFontSize * (currentZoom / 100));
            
            const cmElement = document.querySelector('.CodeMirror');
            if (cmElement) {
                cmElement.style.fontSize = newFontSize + 'px';
            }
            
            document.getElementById('zoomLevel').textContent = currentZoom + '%';
            localStorage.setItem('notepadZoom', currentZoom);
            
            // Refresh editor to recalculate line heights
            if (editor) {
                setTimeout(() => editor.refresh(), 10);
            }
        }

        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                updateZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                updateZoom();
            }
        }

        function zoomReset() {
            currentZoom = 100;
            updateZoom();
            showToast('üîç Zoom reset to 100%');
        }

        function detectLanguage(filename) {
            const ext = '.' + filename.split('.').pop().toLowerCase();
            return extToLang[ext] || 'text';
        }

        // File operations
        function openFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileOpen(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const lang = detectLanguage(file.name);
                createNewTab(file.name, e.target.result, lang);
                showToast(`üìÇ File "${file.name}" loaded`);
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function saveFile() {
            const tab = tabs.find(t => t.id === activeTabId);
            if (!tab) return;

            tab.content = editor.getValue();
            
            const blob = new Blob([editor.getValue()], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = tab.name;
            a.click();
            URL.revokeObjectURL(url);

            tab.modified = false;
            renderTabs();
            saveToStorage();
            showToast(`üíæ File "${tab.name}" saved`);
        }

        function exportAs(format) {
            const tab = tabs.find(t => t.id === activeTabId);
            if (!tab) return;

            const content = editor.getValue();
            const baseName = tab.name.replace(/\.[^/.]+$/, '');

            switch(format) {
                case 'txt':
                    downloadFile(content, baseName + '.txt', 'text/plain');
                    break;
                case 'pdf':
                    exportToPDF(content, baseName);
                    break;
                case 'html':
                    exportToHTML(content, baseName);
                    break;
                case 'doc':
                    exportToDoc(content, baseName);
                    break;
                case 'csv':
                    downloadFile(content, baseName + '.csv', 'text/csv');
                    break;
                case 'tsv':
                    downloadFile(content, baseName + '.tsv', 'text/tab-separated-values');
                    break;
                case 'json':
                    exportToJSON(content, baseName);
                    break;
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], {type: mimeType + ';charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`üì§ Exported as ${filename}`);
        }

        function exportToPDF(content, baseName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const tab = tabs.find(t => t.id === activeTabId);
            const langInfo = languageMap[tab?.language] || languageMap['text'];
            const lines = content.split('\n');
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            const lineNumWidth = 12;
            const maxWidth = pageWidth - (2 * margin) - lineNumWidth;
            const lineHeight = 4.5;
            const headerHeight = 20;
            let y = headerHeight + 10;
            let pageNum = 1;
            
            // Header function
            function addHeader() {
                // Header background
                doc.setFillColor(45, 45, 45);
                doc.rect(0, 0, pageWidth, headerHeight, 'F');
                
                // Title
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(255, 255, 255);
                doc.text(baseName, margin, 10);
                
                // Info
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(180, 180, 180);
                const info = `${langInfo.name} | ${lines.length} lines | ${content.length} characters | ${new Date().toLocaleDateString()}`;
                doc.text(info, margin, 16);
                
                // Page number right
                doc.text(`Page ${pageNum}`, pageWidth - margin - 15, 10);
            }
            
            // Footer function
            function addFooter() {
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text('Generated with Notepad++ Sidebar', margin, pageHeight - 8);
                doc.text(`${new Date().toLocaleString()}`, pageWidth - margin - 35, pageHeight - 8);
            }
            
            // Add first page header
            addHeader();
            
            // Code content
            doc.setFont('Courier', 'normal');
            doc.setFontSize(9);
            
            lines.forEach((line, index) => {
                const lineNum = index + 1;
                const splitLines = doc.splitTextToSize(line || ' ', maxWidth);
                
                splitLines.forEach((splitLine, subIndex) => {
                    if (y > pageHeight - 20) {
                        addFooter();
                        doc.addPage();
                        pageNum++;
                        addHeader();
                        y = headerHeight + 10;
                    }
                    
                    // Line number (only for first part of wrapped line)
                    if (subIndex === 0) {
                        doc.setTextColor(120, 120, 120);
                        doc.text(String(lineNum).padStart(4, ' '), margin, y);
                    }
                    
                    // Code
                    doc.setTextColor(60, 60, 60);
                    doc.text(splitLine, margin + lineNumWidth, y);
                    y += lineHeight;
                });
            });
            
            // Add footer to last page
            addFooter();

            doc.save(baseName + '.pdf');
            showToast(`üìï Exported as ${baseName}.pdf`);
        }

        function exportToHTML(content, baseName) {
            const tab = tabs.find(t => t.id === activeTabId);
            const langInfo = languageMap[tab?.language] || languageMap['text'];
            const lines = content.split('\n');
            const lineCount = lines.length;
            const now = new Date().toLocaleString();
            
            // Generate line numbers HTML
            const codeWithLines = lines.map((line, i) => {
                const num = String(i + 1).padStart(4, ' ');
                return `<span class="line"><span class="line-num">${num}</span><span class="line-content">${escapeHtml(line) || ' '}</span></span>`;
            }).join('\n');
            
            const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${baseName}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e; 
            color: #d4d4d4; 
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header .meta { font-size: 12px; opacity: 0.9; }
        .stats {
            background: #252526;
            padding: 10px 30px;
            font-size: 12px;
            color: #888;
            border-bottom: 1px solid #333;
        }
        .stats span { margin-right: 20px; }
        .code-container {
            padding: 20px 30px;
            overflow-x: auto;
        }
        pre {
            font-family: 'Consolas', 'Monaco', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .line { display: block; }
        .line:hover { background: rgba(255,255,255,0.05); }
        .line-num { 
            color: #555; 
            user-select: none; 
            margin-right: 20px;
            display: inline-block;
            width: 40px;
            text-align: right;
        }
        .line-content { color: #d4d4d4; }
        .footer {
            text-align: center;
            padding: 15px;
            font-size: 11px;
            color: #555;
            border-top: 1px solid #333;
        }
        @media print {
            body { background: white; color: #333; }
            .header { background: #333; -webkit-print-color-adjust: exact; }
            .line-content { color: #333; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>${langInfo.icon} ${baseName}</h1>
            <div class="meta">${langInfo.name}</div>
        </div>
        <div class="meta">${now}</div>
    </div>
    <div class="stats">
        <span>üìÑ ${lineCount} lines</span>
        <span>üìù ${content.length} characters</span>
        <span>üí¨ ${content.split(/\\s+/).filter(w => w).length} words</span>
    </div>
    <div class="code-container">
        <pre>${codeWithLines}</pre>
    </div>
    <div class="footer">
        Generated with Notepad++ Sidebar | ${now}
    </div>
</body>
</html>`;
            downloadFile(html, baseName + '.html', 'text/html');
        }

        function exportToDoc(content, baseName) {
            const tab = tabs.find(t => t.id === activeTabId);
            const langInfo = languageMap[tab?.language] || languageMap['text'];
            const lines = content.split('\n');
            const now = new Date().toLocaleString();
            const wordCount = content.split(/\s+/).filter(w => w).length;
            
            // Generate code with line numbers
            const codeLines = lines.map((line, i) => {
                const num = String(i + 1).padStart(4, ' ').replace(/ /g, '&nbsp;');
                return `<tr><td class="line-num">${num}</td><td class="code">${escapeHtml(line) || '&nbsp;'}</td></tr>`;
            }).join('\n');
            
            const doc = `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" 
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
<head>
    <meta charset="UTF-8">
    <meta name="Author" content="Notepad++ Sidebar">
    <title>${baseName}</title>
    <!--[if gte mso 9]>
    <xml>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>100</w:Zoom>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
        @page {
            size: A4;
            margin: 2cm 2cm 2cm 2cm;
        }
        body {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
        }
        .header {
            background-color: #4a5568;
            color: white;
            padding: 15pt;
            margin-bottom: 15pt;
        }
        .header h1 {
            font-size: 16pt;
            margin: 0 0 5pt 0;
        }
        .header .info {
            font-size: 9pt;
            color: #e2e8f0;
        }
        .stats {
            background-color: #f7fafc;
            padding: 8pt 12pt;
            margin-bottom: 15pt;
            font-size: 9pt;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        .stats span {
            margin-right: 20pt;
        }
        .code-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 9pt;
        }
        .code-table td {
            padding: 1pt 5pt;
            vertical-align: top;
        }
        .line-num {
            color: #a0aec0;
            text-align: right;
            width: 35pt;
            border-right: 1px solid #e2e8f0;
            padding-right: 8pt;
            user-select: none;
        }
        .code {
            padding-left: 10pt;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .footer {
            margin-top: 20pt;
            padding-top: 10pt;
            border-top: 1px solid #e2e8f0;
            font-size: 8pt;
            color: #a0aec0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>${langInfo.icon} ${baseName}</h1>
        <div class="info">Language: ${langInfo.name} | Exported: ${now}</div>
    </div>
    
    <div class="stats">
        <span>üìÑ ${lines.length} lines</span>
        <span>üìù ${content.length} characters</span>
        <span>üí¨ ${wordCount} words</span>
    </div>
    
    <table class="code-table">
        ${codeLines}
    </table>
    
    <div class="footer">
        Generated with Notepad++ Sidebar | Fuad Onate | ${now}
    </div>
</body>
</html>`;
            downloadFile(doc, baseName + '.doc', 'application/msword');
        }

        function exportToJSON(content, baseName) {
            const tab = tabs.find(t => t.id === activeTabId);
            const langInfo = languageMap[tab?.language] || languageMap['text'];
            const lines = content.split('\n');
            const words = content.split(/\s+/).filter(w => w).length;
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim()).length;
            
            const jsonData = {
                metadata: {
                    filename: tab?.name || baseName,
                    language: langInfo.name,
                    languageCode: tab?.language || 'text',
                    created: new Date().toISOString(),
                    generator: 'Notepad++ Sidebar',
                    author: 'Fuad Onate'
                },
                statistics: {
                    lines: lines.length,
                    characters: content.length,
                    charactersNoSpaces: content.replace(/\s/g, '').length,
                    words: words,
                    paragraphs: paragraphs,
                    readingTimeMinutes: Math.ceil(words / 200)
                },
                content: {
                    raw: content,
                    lines: lines
                }
            };
            
            downloadFile(JSON.stringify(jsonData, null, 2), baseName + '.json', 'application/json');
        }

        // Editor operations
        function editorUndo() {
            editor.undo();
        }

        function editorRedo() {
            editor.redo();
        }

        function toggleComment() {
            editor.toggleComment();
        }

        // Find/Replace
        function toggleFind() {
            const panel = document.getElementById('findPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                const sel = editor.getSelection();
                if (sel) document.getElementById('findInput').value = sel;
                document.getElementById('findInput').focus();
                document.getElementById('findInput').select();
                highlightMatches();
            } else {
                clearSearchMarks();
            }
        }

        function toggleFindOption(option) {
            findOptions[option] = !findOptions[option];
            document.getElementById(option + 'Option').classList.toggle('active', findOptions[option]);
            highlightMatches();
        }

        function handleFindKey(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) findPrev();
                else findNext();
            } else if (e.key === 'Escape') {
                toggleFind();
            }
        }

        function getSearchQuery(query) {
            if (!query) return null;
            
            let searchQuery = query;
            
            if (findOptions.word) {
                searchQuery = '\\b' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b';
                return new RegExp(searchQuery, findOptions.case ? 'g' : 'gi');
            }
            
            if (findOptions.regex) {
                try {
                    return new RegExp(query, findOptions.case ? 'g' : 'gi');
                } catch (e) {
                    return null;
                }
            }
            
            return query;
        }

        function highlightMatches() {
            clearSearchMarks();
            const query = document.getElementById('findInput').value;
            if (!query) {
                document.getElementById('findCount').textContent = '';
                return;
            }

            const content = editor.getValue();
            let count = 0;
            const searchQuery = getSearchQuery(query);
            
            if (!searchQuery) {
                document.getElementById('findCount').textContent = '‚ö†Ô∏è Invalid regex';
                return;
            }

            if (typeof searchQuery === 'string') {
                const searchStr = findOptions.case ? content : content.toLowerCase();
                const findStr = findOptions.case ? query : query.toLowerCase();
                let pos = 0;
                
                while ((pos = searchStr.indexOf(findStr, pos)) !== -1) {
                    const from = editor.posFromIndex(pos);
                    const to = editor.posFromIndex(pos + query.length);
                    searchMarks.push(editor.markText(from, to, {className: 'cm-search-match'}));
                    count++;
                    pos += findStr.length;
                }
            } else {
                let match;
                const regex = new RegExp(searchQuery.source, searchQuery.flags.replace('g', '') + 'g');
                while ((match = regex.exec(content)) !== null) {
                    const from = editor.posFromIndex(match.index);
                    const to = editor.posFromIndex(match.index + match[0].length);
                    searchMarks.push(editor.markText(from, to, {className: 'cm-search-match'}));
                    count++;
                    if (match[0].length === 0) regex.lastIndex++;
                }
            }
            
            document.getElementById('findCount').textContent = `‚ú® ${count} found`;
        }

        function clearSearchMarks() {
            searchMarks.forEach(mark => mark.clear());
            searchMarks = [];
        }

        function findNext() {
            const query = document.getElementById('findInput').value;
            if (!query) return;

            const searchQuery = getSearchQuery(query);
            if (!searchQuery) return;
            
            const cursor = editor.getSearchCursor(searchQuery, editor.getCursor('end'), {caseFold: !findOptions.case});
            
            if (cursor.findNext()) {
                editor.setSelection(cursor.from(), cursor.to());
                editor.scrollIntoView({from: cursor.from(), to: cursor.to()}, 50);
            } else {
                const cursor2 = editor.getSearchCursor(searchQuery, {line: 0, ch: 0}, {caseFold: !findOptions.case});
                if (cursor2.findNext()) {
                    editor.setSelection(cursor2.from(), cursor2.to());
                    editor.scrollIntoView({from: cursor2.from(), to: cursor2.to()}, 50);
                    showToast('üîÑ Search restarted from beginning');
                }
            }
        }

        function findPrev() {
            const query = document.getElementById('findInput').value;
            if (!query) return;

            const searchQuery = getSearchQuery(query);
            if (!searchQuery) return;
            
            const cursor = editor.getSearchCursor(searchQuery, editor.getCursor('start'), {caseFold: !findOptions.case});
            
            if (cursor.findPrevious()) {
                editor.setSelection(cursor.from(), cursor.to());
                editor.scrollIntoView({from: cursor.from(), to: cursor.to()}, 50);
            } else {
                const lastLine = editor.lastLine();
                const cursor2 = editor.getSearchCursor(searchQuery, {line: lastLine, ch: editor.getLine(lastLine).length}, {caseFold: !findOptions.case});
                if (cursor2.findPrevious()) {
                    editor.setSelection(cursor2.from(), cursor2.to());
                    editor.scrollIntoView({from: cursor2.from(), to: cursor2.to()}, 50);
                    showToast('üîÑ Search restarted from end');
                }
            }
        }

        function replaceOne() {
            const query = document.getElementById('findInput').value;
            const replacement = document.getElementById('replaceInput').value;
            if (!query) return;

            const selected = editor.getSelection();
            if (selected) {
                const searchQuery = getSearchQuery(query);
                let matches = false;
                
                if (typeof searchQuery === 'string') {
                    matches = findOptions.case ? selected === query : selected.toLowerCase() === query.toLowerCase();
                } else if (searchQuery) {
                    matches = searchQuery.test(selected);
                }

                if (matches) {
                    editor.replaceSelection(replacement);
                    highlightMatches();
                }
            }
            findNext();
        }

        function replaceAll() {
            const query = document.getElementById('findInput').value;
            const replacement = document.getElementById('replaceInput').value;
            if (!query) return;

            let content = editor.getValue();
            let count = 0;
            const searchQuery = getSearchQuery(query);

            if (!searchQuery) {
                showToast('‚ö†Ô∏è Regular expression inv√°lida', true);
                return;
            }

            if (typeof searchQuery === 'string') {
                const searchStr = findOptions.case ? content : content.toLowerCase();
                const findStr = findOptions.case ? query : query.toLowerCase();
                let result = '';
                let lastIndex = 0;
                let pos = 0;
                
                while ((pos = searchStr.indexOf(findStr, lastIndex)) !== -1) {
                    result += content.substring(lastIndex, pos) + replacement;
                    lastIndex = pos + query.length;
                    count++;
                }
                result += content.substring(lastIndex);
                content = result;
            } else {
                const regex = new RegExp(searchQuery.source, searchQuery.flags.replace('g', '') + 'g');
                const matches = content.match(regex);
                count = matches ? matches.length : 0;
                content = content.replace(regex, replacement);
            }

            editor.setValue(content);
            highlightMatches();
            showToast(`‚úÖ ${count} replacements made`);
        }

        // Go to line
        function goToLine() {
            document.getElementById('gotoModal').classList.add('active');
            document.getElementById('gotoLineInput').value = '';
            document.getElementById('gotoLineInput').focus();
        }

        function doGoToLine() {
            const line = parseInt(document.getElementById('gotoLineInput').value);
            if (line && line > 0) {
                editor.setCursor(line - 1, 0);
                editor.scrollIntoView({line: line - 1, ch: 0}, 100);
                editor.focus();
            }
            closeModal('gotoModal');
        }

        function showRenameModal(tabId) {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            document.getElementById('renameInput').value = tab.name;
            document.getElementById('renameModal').classList.add('active');
            document.getElementById('renameModal').dataset.tabId = tabId;
            document.getElementById('renameInput').focus();
            document.getElementById('renameInput').select();
        }

        function doRename() {
            const tabId = document.getElementById('renameModal').dataset.tabId;
            const newName = document.getElementById('renameInput').value.trim();
            
            if (newName && tabId) {
                const tab = tabs.find(t => t.id === tabId);
                if (tab) {
                    tab.name = newName;
                    tab.language = detectLanguage(newName);
                    renderTabs();
                    if (tabId === activeTabId) {
                        document.getElementById('statusFile').textContent = newName;
                        editor.setOption('mode', tab.language);
                        document.getElementById('languageSelect').value = tab.language;
                        const langInfo = languageMap[tab.language] || languageMap['text'];
                        document.getElementById('statusLangIcon').textContent = langInfo.icon;
                        document.getElementById('statusLangName').textContent = langInfo.name;
                    }
                    saveToStorage();
                }
            }
            closeModal('renameModal');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editor.focus();
        }

        // Handle Enter in modals
        document.addEventListener('keydown', (e) => {
            // Global search shortcut: Ctrl+Shift+F
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                openGlobalSearch();
                return;
            }
            
            // Asistente IA shortcut: Ctrl+Shift+A
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                openAIPanel();
                return;
            }
            
            if (e.key === 'Enter') {
                if (document.getElementById('gotoModal').classList.contains('active')) {
                    doGoToLine();
                } else if (document.getElementById('renameModal').classList.contains('active')) {
                    doRename();
                }
            }
            if (e.key === 'Escape') {
                closeModal('gotoModal');
                closeModal('renameModal');
                closeGlobalSearch();
                if (document.getElementById('findPanel').classList.contains('active')) {
                    toggleFind();
                }
            }
        });
        
        // Global search input handler
        document.getElementById('globalSearchInput').addEventListener('input', (e) => {
            updateGlobalSearchResults(e.target.value);
        });
        
        // Close global search when clicking outside
        document.getElementById('globalSearchModal').addEventListener('click', (e) => {
            if (e.target.id === 'globalSearchModal') {
                closeGlobalSearch();
            }
        });

        // Storage
        function saveToStorage() {
            // Don't save during initial page load
            if (isInitialLoad) return;
            
            const currentTab = tabs.find(t => t.id === activeTabId);
            if (currentTab) {
                currentTab.content = editor.getValue();
            }
            
            localStorage.setItem('notepadPlusSidebar', JSON.stringify({
                tabs: tabs,
                activeTabId: activeTabId,
                tabCounter: tabCounter,
                tabGroupCounter: tabGroupCounter
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('notepadPlusSidebar');
            const darkMode = localStorage.getItem('notepadDarkMode');
            const fontSize = localStorage.getItem('notepadFontSize');
            const wrap = localStorage.getItem('notepadWordWrap');
            const zoom = localStorage.getItem('notepadZoom');
            
            if (darkMode !== null) {
                isDarkMode = darkMode === 'true';
            }
            
            if (wrap === 'true') {
                wordWrap = true;
                setTimeout(() => {
                    editor.setOption('lineWrapping', true);
                    document.getElementById('wrapBtn').classList.add('active');
                    document.getElementById('statusWrap').textContent = '‚Ü©Ô∏è Wrap';
                }, 100);
            }
            
            if (fontSize) {
                document.getElementById('fontSizeSelect').value = fontSize;
            }

            if (zoom) {
                currentZoom = parseInt(zoom);
            }
            
            // Apply zoom after fontSize is set (zoom uses fontSize as base)
            setTimeout(() => updateZoom(), 100);
            
            if (saved) {
                const data = JSON.parse(saved);
                tabs = data.tabs || [];
                activeTabId = data.activeTabId;
                tabCounter = data.tabCounter || 0;
                tabGroupCounter = data.tabGroupCounter || 0;
                
                if (tabs.length > 0) {
                    renderTabs();
                    switchTab(activeTabId || tabs[0].id);
                }
            }
            isInitialLoad = false;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            document.getElementById('toastMessage').textContent = message;
            
            if (isError) {
                toast.classList.add('error');
                icon.textContent = '‚ùå';
            } else {
                toast.classList.remove('error');
                icon.textContent = '‚úÖ';
            }
            
            toast.classList.remove('show');
            void toast.offsetWidth;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Tooltip system
        function initTooltips() {
            const tooltip = document.createElement('div');
            tooltip.id = 'customTooltip';
            tooltip.style.cssText = `
                position: fixed;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #fff;
                padding: 8px 14px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
                white-space: nowrap;
                box-shadow: 0 4px 20px rgba(0,0,0,0.4);
                z-index: 99999;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.15s ease;
                font-family: 'Segoe UI', sans-serif;
            `;
            document.body.appendChild(tooltip);

            document.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (target) {
                    const text = target.getAttribute('data-tooltip');
                    tooltip.textContent = text;
                    
                    // Update style for light mode
                    if (document.body.classList.contains('light-mode')) {
                        tooltip.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    } else {
                        tooltip.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
                    }
                    
                    const rect = target.getBoundingClientRect();
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;
                    
                    // Calculate initial position (centered below element)
                    let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                    let top = rect.bottom + 8;
                    
                    // Adjust if tooltip would overflow right edge
                    if (left + tooltipWidth > window.innerWidth - 10) {
                        left = window.innerWidth - tooltipWidth - 10;
                    }
                    
                    // Adjust if tooltip would overflow left edge
                    if (left < 10) {
                        left = 10;
                    }
                    
                    // Adjust if tooltip would overflow bottom edge (show above instead)
                    if (top + tooltipHeight > window.innerHeight - 10) {
                        top = rect.top - tooltipHeight - 8;
                    }
                    
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                    tooltip.style.opacity = '1';
                }
            });

            document.addEventListener('mouseout', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (target) {
                    tooltip.style.opacity = '0';
                }
            });
        }

        // Initialize tooltips on load
        initTooltips();
    </script>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal" onclick="closePreviewModal(event)">
        <div class="preview-modal-content" onclick="event.stopPropagation()">
            <div class="preview-modal-header">
                <h3>üëÅÔ∏è <span id="previewModalTitle">Preview</span></h3>
                <button class="preview-modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="preview-modal-body md-preview-container active" id="previewModalBody"></div>
        </div>
    </div>
</body>
</html>
